<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kedai Buku Sekolah - School Book Shop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #21409a;
      --primary-gradient: linear-gradient(135deg, #21409a 0%, #1a3278 100%);
    }
    body {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      background-color: #f3f4f6;
      overflow-x: hidden; 
    }
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.3s ease-out; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn-primary {
      background: var(--primary-gradient);
      transition: transform 0.2s;
    }
    .btn-primary:active { transform: scale(0.98); }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .input-field {
      font-size: 14px;
      padding: 0.6rem 0.8rem;
    }
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .header-pattern {
      background-color: #21409a;
      background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.15) 1px, transparent 0);
      background-size: 20px 20px;
    }
    .toast {
      position: fixed; top: 1rem; right: 1rem; left: 1rem;
      padding: 12px 16px; border-radius: 8px; color: white;
      z-index: 9999; text-align: center; font-size: 0.9rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      pointer-events: none;
    }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .toast.info { background: #3b82f6; }
    @media (min-width: 768px) {
      body { font-size: 15px; }
      .toast { left: auto; width: auto; min-width: 300px; }
    }
    /* Checkbox styles */
    .custom-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .mobile-stack {
        display: flex;
        flex-direction: column;
    }
    @media (min-width: 768px) {
        .mobile-stack {
            flex-direction: row;
        }
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-full">

  <!-- Header -->
  <header class="header-pattern text-white py-6 md:py-8 shadow-2xl">
   <div class="container mx-auto px-4">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
     <div class="flex flex-col md:flex-row items-center gap-4">
      <div class="bg-white bg-opacity-20 p-3 md:p-4 rounded-2xl backdrop-blur-sm shadow-inner"><i class="fas fa-book-open text-3xl md:text-4xl"></i></div>
      <div>
       <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold tracking-tight leading-tight"><span id="headerTitle">Kedai Buku Sekolah</span></h1>
       <p class="text-blue-100 mt-1 font-medium text-sm md:text-base" id="headerSubtitle">School Book Shop System</p>
      </div>
     </div>
     <div class="flex flex-wrap justify-center items-center gap-2 w-full md:w-auto">
      <div class="flex gap-1 bg-white bg-opacity-10 p-1 rounded-lg backdrop-blur-sm">
        <button onclick="switchLanguage('ms')" id="langMs" class="lang-btn px-3 py-1.5 rounded-md text-white text-sm active hover:bg-white hover:bg-opacity-20 transition-all"> <i class="fas fa-globe mr-1"></i>BM </button> 
        <button onclick="switchLanguage('en')" id="langEn" class="lang-btn px-3 py-1.5 rounded-md text-white text-sm hover:bg-white hover:bg-opacity-20 transition-all"> <i class="fas fa-globe mr-1"></i>EN </button>
      </div>
      <button onclick="openAdminLogin()" class="bg-white bg-opacity-10 backdrop-blur-sm px-4 py-2 rounded-lg hover:bg-opacity-20 transition-all text-sm font-semibold flex items-center gap-2"> <i class="fas fa-user-shield"></i> Admin </button>
     </div>
    </div>
   </div>
  </header>

  <div class="container mx-auto px-4 py-6 md:py-8">
   <!-- Navigation -->
   <div class="mb-8">
    <div class="flex flex-col sm:flex-row gap-3 md:gap-4 justify-center">
        <button onclick="showSection('orderSection')" class="w-full sm:w-auto px-6 py-4 btn-primary text-white rounded-xl font-semibold shadow-lg flex items-center justify-center gap-2 hover:shadow-xl transition-all"> <i class="fas fa-shopping-cart"></i><span data-lang="newOrder">Tempahan Baru</span> </button> 
        <button onclick="showSection('statusSection')" class="w-full sm:w-auto px-6 py-4 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2"> <i class="fas fa-search"></i><span data-lang="checkStatus">Semak Status</span> </button>
    </div>
   </div>

   <!-- Order Section -->
   <div id="orderSection" class="section active">
    <div class="max-w-6xl mx-auto">
     <!-- Step 1: Parent Details -->
     <div id="step1" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6 fade-in card-hover">
      <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-blue-100">
       <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-3 rounded-xl text-white"><i class="fas fa-user-edit text-xl md:text-2xl"></i></div>
       <div>
        <h2 class="text-xl md:text-2xl font-bold text-primary"><span data-lang="step1Title">Langkah 1: Butiran Ibu Bapa &amp; Pelajar</span></h2>
        <p class="text-gray-600 text-xs md:text-sm" data-lang="step1Subtitle">Sila isi maklumat dengan lengkap</p>
       </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm md:text-base" for="parentName"> <i class="fas fa-user text-primary mr-2"></i><span data-lang="parentName">Nama Ibu Bapa/Penjaga</span> </label> <input type="text" id="parentName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Masukkan nama ibu bapa" required></div>
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm md:text-base" for="parentPhone"> <i class="fas fa-phone text-primary mr-2"></i><span data-lang="phoneNumber">Nombor Telefon</span> </label> <input type="tel" id="parentPhone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="0123456789" required></div>
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm md:text-base" for="parentEmail"> <i class="fas fa-envelope text-primary mr-2"></i><span data-lang="emailAddress">Alamat Email</span> </label> <input type="email" id="parentEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="parent@email.com" required></div>
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm md:text-base" for="studentName"> <i class="fas fa-graduation-cap text-primary mr-2"></i><span data-lang="studentName">Nama Pelajar</span> </label> <input type="text" id="studentName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Masukkan nama pelajar" required></div>
       <div class="md:col-span-2"><label class="block text-gray-700 font-semibold mb-2 text-sm md:text-base" for="studentClass"> <i class="fas fa-school text-primary mr-2"></i><span data-lang="class">Kelas</span> </label> <select id="studentClass" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition-all" required> <option value="">Pilih Kelas</option> </select></div>
      </div>
      <div class="mt-8 text-right"><button onclick="proceedToStep2()" class="w-full md:w-auto px-8 py-3.5 btn-primary text-white rounded-xl font-semibold shadow-lg text-base md:text-lg flex items-center justify-center gap-2 md:inline-flex"> <span data-lang="nextStep">Langkah Seterusnya</span> <i class="fas fa-arrow-right"></i> </button></div>
     </div>

     <!-- Step 2: Shopping (Books) -->
     <div id="step2" class="hidden">
      <button onclick="backToStep1()" class="mb-4 px-5 py-2.5 bg-white text-gray-700 rounded-xl hover:bg-gray-50 transition-all shadow-sm font-semibold border border-gray-200 text-sm md:text-base flex items-center gap-2"> <i class="fas fa-arrow-left"></i><span data-lang="back">Kembali</span> </button>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
       <!-- Items List -->
       <div class="lg:col-span-2 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-5 md:p-8 fade-in">
         <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-green-100">
          <div class="bg-gradient-to-br from-green-500 to-green-700 p-3 rounded-xl text-white"><i class="fas fa-shopping-bag text-xl md:text-2xl"></i></div>
          <div>
           <h2 class="text-xl md:text-2xl font-bold text-primary"><span data-lang="step2Title">Langkah 2: Pilih Barang</span></h2>
           <p class="text-gray-600 text-xs md:text-sm" data-lang="step2Subtitle">Pilih buku dan alat tulis yang diperlukan</p>
          </div>
         </div>
         <div class="mb-6 p-4 md:p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border-2 border-blue-200">
            <label class="flex items-center text-gray-700 font-semibold mb-3 text-sm md:text-base" for="packageSelect"> <i class="fas fa-box-open text-xl text-primary mr-3"></i> <span data-lang="quickPackage">Pakej Pantas</span> </label> 
            <select id="packageSelect" class="w-full px-4 py-3 border-2 border-blue-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition-all text-sm md:text-base"> <option value="">-- Pilih Pakej (Pilihan) --</option> </select>
            <p class="text-xs md:text-sm text-gray-600 mt-2"><i class="fas fa-info-circle mr-1"></i><span data-lang="packageInfo">Pilih pakej untuk mengisi troli dengan cepat</span></p>
         </div>
         <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
          <table class="w-full min-w-[600px] md:min-w-0">
           <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
            <tr>
             <th class="px-4 py-3 text-left font-semibold text-sm md:text-base"><span data-lang="itemName">Nama Barang</span></th>
             <th class="px-4 py-3 text-right font-semibold text-sm md:text-base"><span data-lang="price">Harga (RM)</span></th>
             <th class="px-4 py-3 text-center font-semibold text-sm md:text-base"><span data-lang="quantity">Kuantiti</span></th>
            </tr>
           </thead>
           <tbody id="itemsTableBody" class="divide-y divide-gray-200 text-sm md:text-base"></tbody>
          </table>
         </div>
        </div>
       </div>
       <!-- Cart Summary (Step 2) -->
       <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-xl p-5 md:p-6 sticky top-4 fade-in border border-gray-100">
         <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-purple-100">
          <div class="bg-gradient-to-br from-purple-500 to-purple-700 p-2.5 rounded-xl text-white"><i class="fas fa-receipt text-lg"></i></div>
          <h3 class="text-lg md:text-xl font-bold text-primary"><span data-lang="cartSummary">Ringkasan Troli</span></h3>
         </div>
         <div id="cartItems2" class="mb-4 max-h-64 overflow-y-auto cart-items-container pr-2">
            <!-- Content filled by JS -->
         </div>
         <div class="border-t-2 border-gray-200 pt-4 mb-6">
          <div class="flex justify-between items-center"><span class="text-base md:text-lg font-bold text-gray-800"><span data-lang="grandTotal">Jumlah Besar:</span></span> <span class="text-xl md:text-2xl font-bold text-primary">RM <span class="grandTotalDisplay">0.00</span></span></div>
         </div>
         <button onclick="proceedToStep3()" class="w-full px-6 py-3.5 btn-primary text-white rounded-xl font-bold shadow-lg text-base md:text-lg flex items-center justify-center gap-2 hover:shadow-xl transition-all"> <span data-lang="nextStepFees">Seterusnya: Yuran</span> <i class="fas fa-arrow-right"></i> </button>
        </div>
       </div>
      </div>
     </div>

     <!-- Step 3: Fees (Yuran) -->
     <div id="step3" class="hidden">
      <button onclick="backToStep2()" class="mb-4 px-5 py-2.5 bg-white text-gray-700 rounded-xl hover:bg-gray-50 transition-all shadow-sm font-semibold border border-gray-200 text-sm md:text-base flex items-center gap-2"> <i class="fas fa-arrow-left"></i><span data-lang="back">Kembali</span> </button>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
       <!-- Fees List -->
       <div class="lg:col-span-2 space-y-4">
        <div class="bg-white rounded-2xl shadow-xl p-5 md:p-8 fade-in">
         <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-green-100">
          <div class="bg-gradient-to-br from-orange-500 to-red-600 p-3 rounded-xl text-white"><i class="fas fa-money-bill-wave text-xl md:text-2xl"></i></div>
          <div>
           <h2 class="text-xl md:text-2xl font-bold text-primary"><span data-lang="step3Title">Langkah 3: Bayaran Yuran</span></h2>
           <p class="text-gray-600 text-xs md:text-sm" data-lang="step3Subtitle">Sila pilih yuran yang berkaitan (PIBG, Sukan, dll)</p>
          </div>
         </div>
         <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
          <table class="w-full min-w-[600px] md:min-w-0">
           <thead class="bg-gradient-to-r from-orange-600 to-red-600 text-white">
            <tr>
             <th class="px-4 py-3 text-left font-semibold text-sm md:text-base"><span data-lang="feeName">Nama Yuran</span></th>
             <th class="px-4 py-3 text-right font-semibold text-sm md:text-base"><span data-lang="amount">Jumlah (RM)</span></th>
             <th class="px-4 py-3 text-center font-semibold w-24 text-sm md:text-base"><span data-lang="select">Pilih</span></th>
            </tr>
           </thead>
           <tbody id="feesTableBody" class="divide-y divide-gray-200 text-sm md:text-base"></tbody>
          </table>
         </div>
        </div>
       </div>
       <!-- Cart Summary (Step 3 Final) -->
       <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-xl p-5 md:p-6 sticky top-4 fade-in border border-gray-100">
         <div class="flex items-center gap-3 mb-4 pb-4 border-b-2 border-purple-100">
          <div class="bg-gradient-to-br from-purple-500 to-purple-700 p-2.5 rounded-xl text-white"><i class="fas fa-receipt text-lg"></i></div>
          <h3 class="text-lg md:text-xl font-bold text-primary"><span data-lang="cartSummary">Ringkasan Troli</span></h3>
         </div>
         <div id="cartItems3" class="mb-4 max-h-64 overflow-y-auto cart-items-container pr-2">
             <!-- Content filled by JS -->
         </div>
         <div class="border-t-2 border-gray-200 pt-4 mb-6">
          <div class="flex justify-between items-center"><span class="text-base md:text-lg font-bold text-gray-800"><span data-lang="grandTotal">Jumlah Besar:</span></span> <span class="text-xl md:text-2xl font-bold text-primary">RM <span class="grandTotalDisplay">0.00</span></span></div>
         </div>
         <div class="mb-6"><label class="block text-gray-700 font-semibold mb-3 text-sm md:text-base"> <i class="fas fa-credit-card text-primary mr-2"></i><span data-lang="paymentMethod">Kaedah Bayaran</span> </label> <select id="paymentMethod" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm md:text-base"> <option value="Cash">Tunai</option> <option value="Online">Pemindahan Online</option> </select></div>
         <button onclick="submitOrder()" id="submitOrderBtn" class="w-full px-6 py-3.5 btn-secondary text-white rounded-xl font-bold shadow-lg text-base md:text-lg flex items-center justify-center gap-2 hover:shadow-xl transition-all"> <i class="fas fa-check-circle"></i><span data-lang="submitOrder">Hantar Tempahan</span> </button>
        </div>
       </div>
      </div>
     </div>

    </div>
   </div>

   <!-- Status Check Section -->
   <div id="statusSection" class="section">
    <div class="max-w-2xl mx-auto">
     <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 fade-in card-hover">
      <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-orange-100">
       <div class="bg-gradient-to-br from-orange-500 to-orange-700 p-3 rounded-xl text-white"><i class="fas fa-search text-xl md:text-2xl"></i></div>
       <div>
        <h2 class="text-xl md:text-2xl font-bold text-primary"><span data-lang="checkOrderStatus">Semak Status Tempahan</span></h2>
        <p class="text-gray-600 text-xs md:text-sm" data-lang="checkStatusSubtitle">Masukkan nombor telefon untuk semak tempahan</p>
       </div>
      </div>
      <div class="mb-6"><label class="block text-gray-700 font-semibold mb-3 text-sm md:text-base" for="statusPhone"> <i class="fas fa-phone text-primary mr-2"></i><span data-lang="enterPhone">Masukkan Nombor Telefon</span> </label> <input type="tel" id="statusPhone" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg text-center tracking-wider" placeholder="0123456789"></div><button onclick="checkStatus()" class="w-full px-6 py-4 btn-primary text-white rounded-xl font-bold shadow-lg text-base md:text-lg flex items-center justify-center gap-2"> <i class="fas fa-search"></i><span data-lang="searchOrders">Cari Tempahan</span> </button>
      <div id="statusResults" class="mt-6 space-y-3"></div>
     </div>
    </div>
   </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm p-4" style="display: none;">
   <div class="bg-white rounded-2xl p-6 md:p-8 max-w-sm w-full shadow-2xl">
    <div class="text-center mb-6">
     <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-4 rounded-2xl text-white inline-block mb-4"><i class="fas fa-shield-alt text-4xl"></i></div>
     <h3 class="text-2xl font-bold text-primary" data-lang="adminAccess">Akses Admin</h3>
     <p class="text-sm text-gray-600 mt-2" id="adminLoginHint"></p>
    </div>
    <div class="mb-6">
        <label class="block text-gray-700 font-semibold mb-2" for="adminPassword"> 
            <i class="fas fa-lock text-primary mr-2"></i><span data-lang="password">Kata Laluan</span> 
        </label> 
        <div class="relative">
            <input type="password" id="adminPassword" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12" placeholder="Masukkan kata laluan admin" onkeypress="if(event.key === 'Enter') verifyAdminLogin()">
            <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none p-2">
                <i id="passwordToggleIcon" class="fas fa-eye"></i>
            </button>
        </div>
    </div>
    <div class="flex gap-3"><button onclick="closeAdminLogin()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold"> <span data-lang="cancel">Batal</span> </button> <button id="adminLoginBtn" onclick="verifyAdminLogin()" class="flex-1 px-4 py-3 btn-primary text-white rounded-xl shadow-lg font-semibold"> <span data-lang="login">Log Masuk</span> </button></div>
   </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
      <div class="bg-white rounded-2xl p-6 md:p-8 max-w-sm w-full shadow-2xl text-center">
          <div class="bg-red-100 p-4 rounded-full inline-block mb-4">
              <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Pengesahan</h3>
          <p class="text-gray-600 mb-6" id="confirmMessage">Adakah anda pasti?</p>
          <div class="flex flex-col-reverse md:flex-row gap-3">
              <button onclick="closeConfirm()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold">Batal</button>
              <button onclick="executeConfirm()" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all font-semibold shadow-lg">Ya, Padam</button>
          </div>
      </div>
  </div>

  <!-- Order Details Modal (NEW) -->
  <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
      <div class="bg-white rounded-2xl p-6 max-w-2xl w-full shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
          <div class="flex justify-between items-center mb-4 border-b pb-3">
              <h3 class="text-lg md:text-xl font-bold text-primary flex items-center gap-2"><i class="fas fa-file-invoice"></i>Butiran Tempahan</h3>
              <button onclick="document.getElementById('orderDetailsModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 transition-all">&times;</button>
          </div>
          <div class="overflow-y-auto flex-1 pr-2 custom-scrollbar">
              <div id="orderDetailsContent" class="space-y-4">
                  <!-- Content injected by JS -->
              </div>
          </div>
          <div class="mt-4 pt-3 border-t text-right">
              <button onclick="document.getElementById('orderDetailsModal').classList.add('hidden')" class="w-full md:w-auto px-6 py-2.5 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 font-bold transition-all">Tutup</button>
          </div>
      </div>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="fixed inset-0 bg-gray-50 z-40 overflow-y-auto hidden">
   <div class="header-pattern text-white py-4 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4">
     <div class="flex flex-col md:flex-row justify-between items-center gap-3">
        <div class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-start">
            <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2"><i class="fas fa-tools"></i><span data-lang="adminDashboard">Panel Admin</span></h2>
            <div class="md:hidden">
                <button onclick="closeAdminDashboard()" class="text-white opacity-80 hover:opacity-100"><i class="fas fa-times text-xl"></i></button>
            </div>
        </div>
        <div class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-end bg-white/10 md:bg-transparent p-2 md:p-0 rounded-lg">
            <div class="flex gap-2">
                <button onclick="logoutAdmin()" class="px-3 py-1.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-bold shadow text-xs md:text-sm flex items-center gap-1"> <i class="fas fa-sign-out-alt"></i>Logout </button>
                <button onclick="closeAdminDashboard()" class="hidden md:inline-block px-3 py-1.5 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-all font-bold shadow text-xs md:text-sm"> <span data-lang="close">Tutup</span> </button>
            </div>
        </div>
     </div>
    </div>
   </div>
   <div class="container mx-auto px-2 md:px-4 py-6">
    <div class="mb-6 overflow-x-auto pb-2 -mx-2 px-2 md:mx-0 md:px-0">
     <div class="flex flex-nowrap md:flex-wrap gap-2 border-b-2 border-gray-200 bg-white rounded-xl p-2 shadow-sm min-w-max md:min-w-0">
        <button onclick="showAdminTab('ordersTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold border-b-4 border-blue-600 text-blue-600 rounded-t-lg bg-blue-50 text-sm md:text-base transition-all"> <i class="fas fa-list mr-1"></i><span data-lang="orders">Tempahan</span> </button> 
        <button onclick="showAdminTab('analysisTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-chart-pie mr-1"></i><span data-lang="analysis">Analisis</span> </button> 
        <button onclick="showAdminTab('itemsTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-book mr-1"></i><span data-lang="items">Barang</span> </button> 
        <button onclick="showAdminTab('packagesTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-box mr-1"></i><span data-lang="packages">Pakej</span> </button> 
        <button onclick="showAdminTab('classesTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-school mr-1"></i><span data-lang="classes">Kelas</span> </button> 
        <button onclick="showAdminTab('feesTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-money-bill-wave mr-1"></i><span data-lang="fees">Yuran</span> </button> 
        <button onclick="showAdminTab('settingsTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-sliders-h mr-1"></i><span data-lang="settings">Tetapan</span> </button>
        <button onclick="showAdminTab('logsTab')" class="admin-tab flex-shrink-0 px-4 py-2 font-semibold text-gray-600 hover:text-primary rounded-t-lg hover:bg-gray-50 transition-all text-sm md:text-base"> <i class="fas fa-history mr-1"></i><span data-lang="logs">Log</span> </button>
     </div>
    </div>
    <!-- Orders Tab -->
    <div id="ordersTab" class="admin-tab-content">
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      
      <!-- Filter & Search Controls (Responsive) -->
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
         <div class="w-full lg:w-auto flex-1 flex flex-col md:flex-row gap-3">
             <div class="relative flex-1 w-full">
                 <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                 <input type="text" id="adminSearchInput" onkeyup="renderOrders()" placeholder="Cari Nama / HP / ID..." class="w-full pl-10 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500 shadow-sm text-sm">
             </div>
             <select id="adminClassFilter" onchange="renderOrders()" class="w-full md:w-48 px-4 py-3 border rounded-xl bg-white focus:ring-2 focus:ring-blue-500 shadow-sm text-sm">
                 <option value="">Semua Kelas</option>
                 <!-- Populated by JS -->
             </select>
         </div>
         <div class="flex gap-2 w-full lg:w-auto">
             <button onclick="deleteSelectedOrders()" class="flex-1 lg:flex-none px-4 py-3 bg-red-100 text-red-600 rounded-xl hover:bg-red-200 font-bold transition-all whitespace-nowrap text-sm flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i><span data-lang="deleteSelected">Padam</span></button>
         </div>
      </div>

      <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
       <table class="w-full min-w-[800px]">
        <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
         <tr>
             <th class="px-4 py-3 text-center w-12"><input type="checkbox" onchange="toggleSelectAll(this, 'order-checkbox')" class="custom-checkbox w-5 h-5 rounded border-gray-300"></th>
             <th class="px-4 py-3 text-left font-semibold text-sm">ID</th>
             <th class="px-4 py-3 text-left font-semibold text-sm">Pelajar</th>
             <th class="px-4 py-3 text-left font-semibold text-sm">Kelas</th>
             <th class="px-4 py-3 text-left font-semibold text-sm">Jumlah</th>
             <th class="px-4 py-3 text-left font-semibold text-sm">Status</th>
             <th class="px-4 py-3 text-left font-semibold text-sm">Tindakan</th>
         </tr>
        </thead>
        <tbody id="ordersTableBody" class="divide-y divide-gray-200 text-sm"></tbody>
       </table>
      </div>
     </div>
    </div>
    <!-- Analysis Tab -->
    <div id="analysisTab" class="admin-tab-content hidden">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-white shadow-lg"><h4 class="text-sm font-semibold opacity-80 mb-1" data-lang="totalRevenue">Jumlah Jualan</h4><p class="text-2xl md:text-3xl font-bold" id="anaTotalRevenue">RM 0.00</p></div>
          <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 text-white shadow-lg"><h4 class="text-sm font-semibold opacity-80 mb-1" data-lang="totalOrders">Jumlah Tempahan</h4><p class="text-2xl md:text-3xl font-bold" id="anaTotalOrders">0</p></div>
          <div class="bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl p-6 text-white shadow-lg"><h4 class="text-sm font-semibold opacity-80 mb-1" data-lang="completedOrders">Dibayar (Paid)</h4><p class="text-2xl md:text-3xl font-bold" id="anaCompletedOrders">0</p></div>
          <div class="bg-gradient-to-br from-orange-500 to-amber-600 rounded-xl p-6 text-white shadow-lg"><h4 class="text-sm font-semibold opacity-80 mb-1" data-lang="pendingOrders">Baru (New)</h4><p class="text-2xl md:text-3xl font-bold" id="anaPendingOrders">0</p></div>
      </div>
      <div class="bg-white rounded-2xl shadow-xl p-6 mt-6">
       <h3 class="text-lg md:text-xl font-bold text-primary mb-6 flex items-center gap-2"><i class="fas fa-chart-bar"></i><span data-lang="statusAnalytics">Analisis Status Tempahan</span></h3>
       <div class="space-y-6">
        <div>
         <div class="flex justify-between mb-2"><span class="text-sm font-bold text-gray-700"><span data-lang="new">Baru</span> (New)</span> <span class="text-sm font-bold text-gray-700" id="statNewCount">0</span></div>
         <div class="w-full bg-gray-100 rounded-full h-4 shadow-inner">
          <div id="barNew" class="bg-yellow-400 h-4 rounded-full transition-all duration-500 shadow-sm" style="width: 0%"></div>
         </div>
        </div>
        <div>
         <div class="flex justify-between mb-2"><span class="text-sm font-bold text-gray-700"><span data-lang="processing">Dalam Proses</span> (Processing)</span> <span class="text-sm font-bold text-gray-700" id="statProcessingCount">0</span></div>
         <div class="w-full bg-gray-100 rounded-full h-4 shadow-inner">
          <div id="barProcessing" class="bg-blue-500 h-4 rounded-full transition-all duration-500 shadow-sm" style="width: 0%"></div>
         </div>
        </div>
        <div>
         <div class="flex justify-between mb-2"><span class="text-sm font-bold text-gray-700"><span data-lang="paid">Dibayar</span> (Paid)</span> <span class="text-sm font-bold text-gray-700" id="statPaidCount">0</span></div>
         <div class="w-full bg-gray-100 rounded-full h-4 shadow-inner">
          <div id="barPaid" class="bg-green-500 h-4 rounded-full transition-all duration-500 shadow-sm" style="width: 0%"></div>
         </div>
        </div>
       </div>
      </div>
    </div>
    <!-- Items Tab -->
    <div id="itemsTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
       <h3 class="text-lg md:text-xl font-bold text-primary"><i class="fas fa-list-ul mr-2"></i><span data-lang="itemsManagement">Pengurusan Barang</span></h3>
       <div class="flex gap-2 w-full md:w-auto">
           <button onclick="deleteSelectedItems()" class="flex-1 md:flex-none px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-bold transition-all text-sm flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i><span data-lang="deleteSelected">Padam</span></button>
           <button onclick="showAddItemForm()" class="flex-1 md:flex-none px-4 py-2 btn-primary text-white rounded-lg shadow-lg font-semibold text-sm flex items-center justify-center gap-2"> <i class="fas fa-plus"></i><span data-lang="addItem">Tambah</span> </button>
       </div>
      </div>
      <div id="addItemForm" class="hidden mb-6 p-4 md:p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl border-2 border-blue-200">
       <h4 class="font-bold text-lg mb-4 text-primary"><span data-lang="addNewItem">Tambah Barang Baru</span></h4>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="newItemName"><span data-lang="itemName">Nama Barang</span></label> <input type="text" id="newItemName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="Masukkan nama barang"></div>
        <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="newItemPrice"><span data-lang="price">Harga (RM)</span></label> <input type="number" id="newItemPrice" step="0.01" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="0.00"></div>
       </div>
       <div class="flex gap-3 mt-4">
           <button onclick="hideAddItemForm()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold text-sm"> <span data-lang="cancel">Batal</span> </button> 
           <button onclick="addItem()" class="flex-1 px-4 py-3 btn-secondary text-white rounded-xl shadow-lg font-semibold text-sm"> <i class="fas fa-save mr-2"></i><span data-lang="saveItem">Simpan</span> </button>
       </div>
      </div>
      <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
       <table class="w-full min-w-[600px] md:min-w-0">
        <thead class="bg-gradient-to-r from-green-600 to-teal-600 text-white">
         <tr>
          <th class="px-4 py-3 text-center w-12"><input type="checkbox" onchange="toggleSelectAll(this, 'item-checkbox')" class="custom-checkbox w-5 h-5"></th>
          <th class="px-4 py-3 text-left font-semibold text-sm"><span data-lang="itemName">Nama Barang</span></th>
          <th class="px-4 py-3 text-right font-semibold text-sm"><span data-lang="price">Harga (RM)</span></th>
          <th class="px-4 py-3 text-center font-semibold text-sm"><span data-lang="actions">Tindakan</span></th>
         </tr>
        </thead>
        <tbody id="itemsAdminTableBody" class="divide-y divide-gray-200 text-sm"></tbody>
       </table>
      </div>
     </div>
    </div>
    <!-- Packages Tab -->
    <div id="packagesTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
       <h3 class="text-lg md:text-xl font-bold text-primary"><i class="fas fa-boxes mr-2"></i><span data-lang="packageManagement">Pengurusan Pakej</span></h3>
       <div class="flex gap-2 w-full md:w-auto">
            <button onclick="deleteSelectedPackages()" class="flex-1 md:flex-none px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-bold transition-all text-sm flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i><span data-lang="deleteSelected">Padam</span></button>
            <button onclick="showAddPackageForm()" class="flex-1 md:flex-none px-4 py-2 btn-primary text-white rounded-lg shadow-lg font-semibold text-sm flex items-center justify-center gap-2"> <i class="fas fa-plus"></i><span data-lang="addPackage">Tambah</span> </button>
       </div>
      </div>
      <div id="addPackageForm" class="hidden mb-6 p-4 md:p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl border-2 border-purple-200">
       <h4 class="font-bold text-lg mb-4 text-primary"><span data-lang="createNewPackage">Cipta Pakej Baru</span></h4>
       <div class="mb-4"><label class="block text-gray-700 font-semibold mb-2 text-sm" for="newPackageName"><span data-lang="packageName">Nama Pakej</span></label> <input type="text" id="newPackageName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="contoh: Set Lengkap Tahun 1"></div>
       <div class="mb-4"><label class="block text-gray-700 font-semibold mb-2 text-sm"><span data-lang="selectItems">Pilih Barang</span></label>
        <div id="packageItemsList" class="space-y-2 max-h-48 md:max-h-64 overflow-y-auto border-2 border-gray-300 rounded-xl p-3 md:p-4 bg-white custom-scrollbar"></div>
       </div>
       <div class="flex gap-3">
           <button onclick="hideAddPackageForm()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold text-sm"> <span data-lang="cancel">Batal</span> </button> 
           <button onclick="addPackage()" class="flex-1 px-4 py-3 btn-secondary text-white rounded-xl shadow-lg font-semibold text-sm"> <i class="fas fa-save mr-2"></i><span data-lang="savePackage">Simpan</span> </button>
       </div>
      </div>
      <div id="packagesListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
     </div>
    </div>
    <!-- Classes Tab -->
    <div id="classesTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <div class="bg-white rounded-2xl shadow-xl p-6">
      <h3 class="text-xl font-bold text-primary mb-6"><i class="fas fa-chalkboard-teacher mr-2"></i><span data-lang="classManagement">Pengurusan Kelas</span></h3>
      <div class="mb-6 p-6 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-2xl border-2 border-orange-200"><label class="block text-gray-700 font-semibold mb-3 text-sm" for="newClassName"><span data-lang="addNewClass">Tambah Kelas Baru</span></label>
       <div class="flex gap-3"><input type="text" id="newClassName" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="contoh: Tahun 1A"> <button onclick="addClass()" class="px-6 py-3 btn-primary text-white rounded-xl shadow-lg font-semibold text-sm"> <i class="fas fa-plus mr-2"></i><span data-lang="add">Tambah</span> </button></div>
      </div>
      <div id="classesListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
     </div>
    </div>
    <!-- Fees Tab (PIBG) -->
    <div id="feesTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
       <h3 class="text-lg md:text-xl font-bold text-primary"><i class="fas fa-money-check-alt mr-2"></i><span data-lang="feesManagement">Pengurusan Yuran PIBG</span></h3>
       <div class="flex gap-2 w-full md:w-auto">
            <button onclick="deleteSelectedFees()" class="flex-1 md:flex-none px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 font-bold transition-all text-sm flex items-center justify-center gap-2"><i class="fas fa-trash-alt"></i><span data-lang="deleteSelected">Padam</span></button>
            <button onclick="showAddFeeForm()" class="flex-1 md:flex-none px-4 py-2 btn-primary text-white rounded-lg shadow-lg font-semibold text-sm flex items-center justify-center gap-2"> <i class="fas fa-plus"></i><span data-lang="addFee">Tambah</span> </button>
       </div>
      </div>
      <div id="addFeeForm" class="hidden mb-6 p-4 md:p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border-2 border-green-200">
       <h4 class="font-bold text-lg mb-4 text-primary"><span data-lang="addNewFee">Tambah Yuran Baru</span></h4>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="newFeeName"><span data-lang="feeName">Nama Yuran</span></label> <input type="text" id="newFeeName" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" placeholder="cth: Yuran PIBG 2024"></div>
        <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="newFeeAmount"><span data-lang="amount">Jumlah (RM)</span></label> <input type="number" id="newFeeAmount" step="0.01" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" placeholder="0.00"></div>
        <div class="md:col-span-2"><label class="block text-gray-700 font-semibold mb-2 text-sm" for="newFeeDescription"><span data-lang="description">Keterangan</span></label> <textarea id="newFeeDescription" rows="3" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" placeholder="Keterangan tambahan (pilihan)"></textarea></div>
       </div>
       <div class="flex gap-3 mt-4">
           <button onclick="hideAddFeeForm()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-all font-semibold text-sm"> <span data-lang="cancel">Batal</span> </button> 
           <button onclick="addFee()" class="flex-1 px-4 py-3 btn-secondary text-white rounded-xl shadow-lg font-semibold text-sm"> <i class="fas fa-save mr-2"></i><span data-lang="saveFee">Simpan</span> </button>
       </div>
      </div>
      <div class="overflow-x-auto rounded-xl border-2 border-gray-200">
       <table class="w-full min-w-[600px] md:min-w-0">
        <thead class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
         <tr>
          <th class="px-4 py-3 text-center w-12"><input type="checkbox" onchange="toggleSelectAll(this, 'fee-checkbox')" class="custom-checkbox w-5 h-5"></th>
          <th class="px-4 py-3 text-left font-semibold text-sm"><span data-lang="feeName">Nama Yuran</span></th>
          <th class="px-4 py-3 text-right font-semibold text-sm"><span data-lang="amount">Jumlah (RM)</span></th>
          <th class="px-4 py-3 text-left font-semibold text-sm"><span data-lang="description">Keterangan</span></th>
          <th class="px-4 py-3 text-center font-semibold text-sm"><span data-lang="actions">Tindakan</span></th>
         </tr>
        </thead>
        <tbody id="feesAdminTableBody" class="divide-y divide-gray-200 text-sm"></tbody>
       </table>
      </div>
     </div>
    </div>
    <!-- LOGS Tab (NEW) -->
    <div id="logsTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-lg md:text-xl font-bold text-primary"><i class="fas fa-history mr-2"></i><span data-lang="logs">Log Aktiviti</span></h3>
       <button onclick="loadLogs()" class="px-4 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 font-bold transition-all text-sm flex items-center gap-2"><i class="fas fa-sync-alt"></i>Refresh</button>
      </div>
      <div class="overflow-x-auto rounded-xl border-2 border-gray-200 max-h-[600px]">
       <table class="w-full min-w-[600px]">
        <thead class="bg-gradient-to-r from-gray-700 to-gray-800 text-white sticky top-0">
         <tr>
          <th class="px-4 py-3 text-left font-semibold w-32 text-sm"><span data-lang="logTime">Masa</span></th>
          <th class="px-4 py-3 text-left font-semibold w-32 text-sm"><span data-lang="orderId">ID</span></th>
          <th class="px-4 py-3 text-left font-semibold w-40 text-sm"><span data-lang="logAction">Tindakan</span></th>
          <th class="px-4 py-3 text-left font-semibold text-sm"><span data-lang="logDetails">Butiran</span></th>
         </tr>
        </thead>
        <tbody id="logsTableBody" class="divide-y divide-gray-200 text-sm"></tbody>
       </table>
      </div>
     </div>
    </div>
    <!-- Settings Tab -->
    <!-- ... same as before ... -->
    <div id="settingsTab" class="admin-tab-content hidden">
      <!-- ... content ... -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl shadow-xl p-6 cursor-pointer hover:shadow-2xl transition-all border border-blue-50" onclick="showAdminTab('telegramTab')">
          <div class="flex items-center gap-4 mb-4">
            <div class="bg-blue-100 p-4 rounded-full text-blue-600"><i class="fab fa-telegram text-3xl"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-800" data-lang="telegramSettings">Tetapan Telegram Bot</h3>
              <p class="text-sm text-gray-500">Notifikasi order ke Telegram</p>
            </div>
          </div>
          <div id="telegramStatusMain" class="text-sm font-medium text-gray-600 bg-gray-50 p-2 rounded text-center border border-gray-200">Checking...</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-6 cursor-pointer hover:shadow-2xl transition-all border border-green-50" onclick="showAdminTab('googleSheetTab')">
          <div class="flex items-center gap-4 mb-4">
            <div class="bg-green-100 p-4 rounded-full text-green-600"><i class="fab fa-google text-3xl"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-800" data-lang="googleSheetSettings">Tetapan Google Sheet</h3>
              <p class="text-sm text-gray-500">Simpan data ke Spreadsheet</p>
            </div>
          </div>
          <div id="googleSheetStatusMain" class="text-sm font-medium text-gray-600 bg-gray-50 p-2 rounded text-center border border-gray-200">Checking...</div>
        </div>
      </div>
    </div>
    <!-- Telegram Detail Tab -->
    <div id="telegramTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <button onclick="showAdminTab('settingsTab')" class="mb-4 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all font-semibold text-sm flex items-center gap-2"><i class="fas fa-arrow-left"></i>Back</button>
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-blue-100">
       <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-3 rounded-xl text-white"><i class="fab fa-telegram text-xl md:text-3xl"></i></div>
       <div>
        <h3 class="text-lg md:text-xl font-bold text-primary"><span data-lang="telegramSettings">Tetapan Telegram Bot</span></h3>
        <p class="text-xs md:text-sm text-gray-600"><span data-lang="telegramSubtitle">Hantar notifikasi order automatik ke Telegram</span></p>
       </div>
      </div>
      <div class="mb-6 p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl border-2 border-blue-200 overflow-hidden">
       <h4 class="font-bold text-base md:text-lg mb-3 text-blue-800"><i class="fas fa-info-circle mr-2"></i><span data-lang="howToSetup">Cara Setup Telegram Bot</span></h4>
       <ol class="space-y-2 text-xs md:text-sm text-gray-700 ml-4 list-decimal">
        <li><span data-lang="step1Telegram">Buka Telegram dan cari <b>@BotFather</b></span></li>
        <li><span data-lang="step2Telegram">Hantar command: <code class="bg-blue-100 px-2 py-1 rounded">/newbot</code></span></li>
        <li><span data-lang="step3Telegram">Ikut arahan dan dapatkan <b>Bot Token</b></span></li>
        <li><span data-lang="step4Telegram">Buat grup Telegram dan tambah bot anda ke grup</span></li>
        <li><span data-lang="step5Telegram">Hantar mesej dalam grup, kemudian buka link update</span></li>
        <li><span data-lang="step6Telegram">Cari <b>"chat":{"id":...}</b> - itu Chat ID anda!</span></li>
       </ol>
      </div>
      <div class="space-y-4">
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="telegramBotToken"> <i class="fas fa-key text-primary mr-2"></i><span data-lang="botToken">Bot Token</span> </label> <input type="text" id="telegramBotToken" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
        <p class="text-xs text-gray-500 mt-1"><span data-lang="botTokenHint">Token dari @BotFather</span></p>
       </div>
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="telegramChatId"> <i class="fas fa-comments text-primary mr-2"></i><span data-lang="chatId">Chat ID</span> </label> <input type="text" id="telegramChatId" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="-1234567890">
        <p class="text-xs text-gray-500 mt-1"><span data-lang="chatIdHint">ID grup atau chat Telegram</span></p>
       </div>
       <div class="flex flex-col sm:flex-row gap-3">
           <button onclick="testTelegramConnection()" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl shadow-lg font-semibold hover:shadow-xl transition-all text-sm flex items-center justify-center gap-2"> <i class="fas fa-paper-plane"></i><span data-lang="testConnection">Test Sambungan</span> </button> 
           <button onclick="saveTelegramSettings()" class="flex-1 px-6 py-3 btn-secondary text-white rounded-xl shadow-lg font-semibold text-sm flex items-center justify-center gap-2"> <i class="fas fa-save"></i><span data-lang="saveSettings">Simpan Tetapan</span> </button>
       </div>
      </div>
      <div id="telegramStatus" class="mt-6 p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
       <p class="text-sm text-gray-600"><i class="fas fa-info-circle mr-2"></i><span data-lang="telegramStatusInfo">Status: Telegram belum dikonfigurasi</span></p>
      </div>
     </div>
    </div>
    <!-- Google Sheet Detail Tab -->
    <div id="googleSheetTab" class="admin-tab-content hidden">
     <!-- ... content ... -->
     <button onclick="showAdminTab('settingsTab')" class="mb-4 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all font-semibold text-sm flex items-center gap-2"><i class="fas fa-arrow-left"></i>Back</button>
     <div class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
      <div class="flex items-center gap-3 mb-6 pb-4 border-b-2 border-green-100">
       <div class="bg-gradient-to-br from-green-500 to-green-700 p-3 rounded-xl text-white"><i class="fab fa-google text-xl md:text-3xl"></i></div>
       <div>
        <h3 class="text-lg md:text-xl font-bold text-primary"><span data-lang="googleSheetSettings">Tetapan Google Sheet</span></h3>
        <p class="text-xs md:text-sm text-gray-600"><span data-lang="googleSheetSubtitle">Simpan tempahan automatik ke Google Sheets</span></p>
       </div>
      </div>
      <div class="mb-6 p-4 bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border-2 border-green-200">
       <h4 class="font-bold text-base md:text-lg mb-3 text-green-800"><i class="fas fa-info-circle mr-2"></i><span data-lang="howToSetupSheet">Cara Setup Google Sheet</span></h4>
       <ol class="space-y-2 text-xs md:text-sm text-gray-700 ml-4 list-decimal">
        <li><span data-lang="step1Sheet">Buka Google Sheets dan buat spreadsheet baru</span></li>
        <li><span data-lang="step2Sheet">Klik <b>Extensions  Apps Script</b></span></li>
        <li><span data-lang="step3Sheet">Padam kod sedia ada, salin kod dari bawah dan paste</span></li>
        <li><span data-lang="step4Sheet">Klik <b>Deploy  New deployment</b></span></li>
        <li><span data-lang="step5Sheet">Pilih <b>Web app</b>, set "Execute as: Me" dan "Who has access: Anyone"</span></li>
        <li><span data-lang="step6Sheet">Klik <b>Deploy</b>, copy <b>Web app URL</b> dan paste di bawah</span></li>
       </ol>
      </div>
      <div class="mb-6"><label class="block text-gray-700 font-semibold mb-3 text-sm"> <i class="fas fa-code text-green-600 mr-2"></i><span data-lang="appsScriptCode">Kod Apps Script (Copy &amp; Paste)</span> </label>
       <div class="relative"><textarea id="appsScriptCode" readonly class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl bg-gray-50 font-mono text-xs h-48 md:h-64 resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent" style="font-family: 'Courier New', monospace;">function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Tarikh/Date', 'Order ID', 'Nama Ibu Bapa/Parent Name', 'Telefon/Phone', 'Email', 'Nama Pelajar/Student Name', 'Kelas/Class', 'Barang/Items', 'Kaedah Bayaran/Payment', 'Jumlah/Total (RM)', 'Status']);
      const headerRange = sheet.getRange(1, 1, 1, 11);
      headerRange.setBackground('#21409a');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
    }
    
    const data = JSON.parse(e.postData.contents);
    
    let itemsList = '';
    if (data.items) {
      for (const [itemId, item] of Object.entries(data.items)) {
        itemsList += `${item.name} (${item.quantity}x RM${item.price.toFixed(2)})\n`;
      }
    }
    
    sheet.appendRow([
      new Date(data.timestamp || Date.now()),
      data.orderId || '',
      data.parentName || '',
      data.parentPhone || '',
      data.parentEmail || '',
      data.studentName || '',
      data.studentClass || '',
      itemsList.trim(),
      data.paymentMethod || '',
      data.total || 0,
      data.status || 'New'
    ]);
    
    const lastRow = sheet.getLastRow();
    const dataRange = sheet.getRange(lastRow, 1, 1, 11);
    dataRange.setHorizontalAlignment('left');
    dataRange.setVerticalAlignment('top');
    dataRange.setWrap(true);
    for (let i = 1; i <= 11; i++) sheet.autoResizeColumn(i);
    
    return ContentService.createTextOutput(JSON.stringify({status: 'success', message: 'Data saved'})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({status: 'error', message: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}</textarea> <button onclick="copyAppsScriptCode()" class="absolute top-2 right-2 px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all text-xs font-semibold shadow-md flex items-center gap-1"> <i class="fas fa-copy"></i><span data-lang="copyCode">Copy</span> </button>
       </div>
      </div>
      <div class="space-y-4">
       <div><label class="block text-gray-700 font-semibold mb-2 text-sm" for="googleSheetUrl"> <i class="fas fa-link text-green-600 mr-2"></i><span data-lang="webAppUrl">Web App URL</span> </label> <input type="text" id="googleSheetUrl" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl input-focus focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" placeholder="https://script.google.com/macros/s/...../exec">
        <p class="text-xs text-gray-500 mt-1"><span data-lang="webAppUrlHint">URL dari Google Apps Script deployment</span></p>
       </div>
       <div class="flex flex-col sm:flex-row gap-3">
           <button onclick="testGoogleSheetConnection()" class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl shadow-lg font-semibold hover:shadow-xl transition-all text-sm flex items-center justify-center gap-2"> <i class="fas fa-vial"></i><span data-lang="testConnection">Test Sambungan</span> </button> 
           <button onclick="saveGoogleSheetSettings()" class="flex-1 px-6 py-3 btn-secondary text-white rounded-xl shadow-lg font-semibold text-sm flex items-center justify-center gap-2"> <i class="fas fa-save"></i><span data-lang="saveSettings">Simpan Tetapan</span> </button>
       </div>
      </div>
      <div id="googleSheetStatus" class="mt-6 p-4 bg-gray-50 rounded-xl border-2 border-gray-200">
       <p class="text-sm text-gray-600"><i class="fas fa-info-circle mr-2"></i><span data-lang="googleSheetStatusInfo">Status: Google Sheet belum dikonfigurasi</span></p>
      </div>
     </div>
    </div>
   </div>
  </div>

  <script>
    // ... translations ...
    const translations = {
      ms: {
        // ... same translations ...
        newOrder: "Tempahan Baru",
        checkStatus: "Semak Status",
        step1Title: "Langkah 1: Butiran Ibu Bapa & Pelajar",
        step1Subtitle: "Sila isi maklumat dengan lengkap",
        parentName: "Nama Ibu Bapa/Penjaga",
        phoneNumber: "Nombor Telefon",
        emailAddress: "Alamat Email",
        studentName: "Nama Pelajar",
        class: "Kelas",
        selectClass: "Pilih Kelas",
        nextStep: "Langkah Seterusnya",
        back: "Kembali",
        step2Title: "Langkah 2: Pilih Barang",
        step2Subtitle: "Pilih buku dan alat tulis yang diperlukan",
        quickPackage: "Pakej Pantas",
        selectPackage: "-- Pilih Pakej (Pilihan) --",
        packageInfo: "Pilih pakej untuk mengisi troli dengan cepat",
        itemName: "Nama Barang",
        price: "Harga (RM)",
        quantity: "Kuantiti",
        cartSummary: "Ringkasan Troli",
        noItems: "Tiada barang dipilih",
        grandTotal: "Jumlah Besar:",
        paymentMethod: "Kaedah Bayaran",
        cash: "Tunai",
        online: "Pemindahan Online",
        submitOrder: "Hantar Tempahan",
        checkOrderStatus: "Semak Status Tempahan",
        checkStatusSubtitle: "Masukkan nombor telefon untuk semak tempahan",
        enterPhone: "Masukkan Nombor Telefon",
        searchOrders: "Cari Tempahan",
        adminAccess: "Akses Admin",
        password: "Kata Laluan",
        cancel: "Batal",
        login: "Log Masuk",
        adminDashboard: "Panel Admin",
        close: "Tutup",
        orders: "Tempahan",
        analysis: "Analisis",
        items: "Barang",
        packages: "Pakej",
        classes: "Kelas",
        telegram: "Telegram",
        orderManagement: "Pengurusan Tempahan",
        orderId: "ID Tempahan",
        parent: "Ibu Bapa",
        student: "Pelajar",
        total: "Jumlah",
        status: "Status",
        actions: "Tindakan",
        itemsManagement: "Pengurusan Barang",
        addItem: "Tambah Barang",
        addNewItem: "Tambah Barang Baru",
        saveItem: "Simpan Barang",
        packageManagement: "Pengurusan Pakej",
        addPackage: "Tambah Pakej",
        createNewPackage: "Cipta Pakej Baru",
        packageName: "Nama Pakej",
        selectItems: "Pilih Barang",
        savePackage: "Simpan Pakej",
        classManagement: "Pengurusan Kelas",
        addNewClass: "Tambah Kelas Baru",
        add: "Tambah",
        editItem: "Edit Barang",
        saveChanges: "Simpan",
        orderDetails: "Butiran Tempahan",
        view: "Lihat",
        edit: "Edit",
        delete: "Padam",
        print: "Cetak",
        new: "Baru",
        paid: "Dibayar",
        done: "Selesai",
        processing: "Dalam Proses",
        step3Title: "Langkah 3: Bayaran Yuran",
        step3Subtitle: "Sila pilih yuran yang berkaitan (PIBG, Sukan, dll)",
        feeName: "Nama Yuran",
        amount: "Jumlah (RM)",
        description: "Keterangan",
        select: "Pilih",
        nextStepFees: "Seterusnya: Yuran",
        fees: "Yuran PIBG",
        feesManagement: "Pengurusan Yuran PIBG",
        addFee: "Tambah Yuran",
        addNewFee: "Tambah Yuran Baru",
        saveFee: "Simpan Yuran",
        editFee: "Edit Yuran",
        telegramSettings: "Tetapan Telegram Bot",
        telegramSubtitle: "Hantar notifikasi order automatik ke Telegram",
        howToSetup: "Cara Setup Telegram Bot",
        step1Telegram: "Buka Telegram dan cari @BotFather",
        step2Telegram: "Hantar command: /newbot",
        step3Telegram: "Ikut arahan dan dapatkan Bot Token",
        step4Telegram: "Buat grup Telegram dan tambah bot anda ke grup",
        step5Telegram: "Hantar mesej dalam grup, kemudian buka link update",
        step6Telegram: "Cari \"chat\":{\"id\":-1234567890} - itu Chat ID anda!",
        botToken: "Bot Token",
        botTokenHint: "Token dari @BotFather",
        chatId: "Chat ID",
        chatIdHint: "ID grup atau chat Telegram",
        testConnection: "Test Sambungan",
        saveSettings: "Simpan Tetapan",
        telegramStatusInfo: "Status: Telegram belum dikonfigurasi",
        googleSheet: "Google Sheet",
        googleSheetSettings: "Tetapan Google Sheet",
        googleSheetSubtitle: "Simpan tempahan automatik ke Google Sheets",
        howToSetupSheet: "Cara Setup Google Sheet",
        step1Sheet: "Buka Google Sheets dan buat spreadsheet baru",
        step2Sheet: "Klik Extensions  Apps Script",
        step3Sheet: "Padam kod sedia ada, salin kod dari bawah dan paste",
        step4Sheet: "Klik Deploy  New deployment",
        step5Sheet: "Pilih Web app, set \"Execute as: Me\" dan \"Who has access: Anyone\"",
        step6Sheet: "Klik Deploy, copy Web app URL dan paste di bawah",
        appsScriptCode: "Kod Apps Script (Copy & Paste)",
        copyCode: "Copy Kod",
        webAppUrl: "Web App URL",
        webAppUrlHint: "URL dari Google Apps Script deployment",
        googleSheetStatusInfo: "Status: Google Sheet belum dikonfigurasi",
        totalRevenue: "Jumlah Jualan",
        totalOrders: "Jumlah Tempahan",
        completedOrders: "Dibayar",
        pendingOrders: "Baru",
        statusAnalytics: "Analisis Status Tempahan",
        settings: "Tetapan",
        deleteSelected: "Padam Terpilih",
        logs: "Log",
        logTime: "Masa",
        logAction: "Tindakan",
        logDetails: "Butiran"
      },
      en: {
        // ... same translations ...
        newOrder: "New Order",
        checkStatus: "Check Status",
        step1Title: "Step 1: Parent & Student Details",
        step1Subtitle: "Please fill in all information",
        parentName: "Parent/Guardian Name",
        phoneNumber: "Phone Number",
        emailAddress: "Email Address",
        studentName: "Student Name",
        class: "Class",
        selectClass: "Select Class",
        nextStep: "Next Step",
        back: "Back",
        step2Title: "Step 2: Select Items",
        step2Subtitle: "Choose required books and stationery",
        quickPackage: "Quick Package",
        selectPackage: "-- Select a Package (Optional) --",
        packageInfo: "Select a package to quickly fill your cart",
        itemName: "Item Name",
        price: "Price (RM)",
        quantity: "Quantity",
        cartSummary: "Cart Summary",
        noItems: "No items selected",
        grandTotal: "Grand Total:",
        paymentMethod: "Payment Method",
        cash: "Cash",
        online: "Online Transfer",
        submitOrder: "Submit Order",
        checkOrderStatus: "Check Order Status",
        checkStatusSubtitle: "Enter phone number to check orders",
        enterPhone: "Enter Phone Number",
        searchOrders: "Search Orders",
        adminAccess: "Admin Access",
        password: "Password",
        cancel: "Cancel",
        login: "Login",
        adminDashboard: "Admin Dashboard",
        close: "Close",
        orders: "Orders",
        analysis: "Analysis",
        items: "Items",
        packages: "Packages",
        classes: "Classes",
        telegram: "Telegram",
        orderManagement: "Order Management",
        orderId: "Order ID",
        parent: "Parent",
        student: "Student",
        total: "Total",
        status: "Status",
        actions: "Actions",
        itemsManagement: "Items Management",
        addItem: "Add Item",
        addNewItem: "Add New Item",
        saveItem: "Save Item",
        packageManagement: "Package Management",
        addPackage: "Add Package",
        createNewPackage: "Create New Package",
        packageName: "Package Name",
        selectItems: "Select Items",
        savePackage: "Save Package",
        classManagement: "Class Management",
        addNewClass: "Add New Class",
        add: "Add",
        editItem: "Edit Item",
        saveChanges: "Save Changes",
        orderDetails: "Order Details",
        view: "View",
        edit: "Edit",
        delete: "Delete",
        print: "Print",
        new: "New",
        paid: "Paid",
        done: "Done",
        processing: "Processing",
        step3Title: "Step 3: Fee Payment",
        step3Subtitle: "Please select relevant fees (PIBG, Sports, etc)",
        feeName: "Fee Name",
        amount: "Amount (RM)",
        description: "Description",
        select: "Select",
        nextStepFees: "Next: Fees",
        fees: "PIBG Fees",
        feesManagement: "PIBG Fees Management",
        addFee: "Add Fee",
        addNewFee: "Add New Fee",
        saveFee: "Save Fee",
        editFee: "Edit Fee",
        telegramSettings: "Telegram Bot Settings",
        telegramSubtitle: "Send automatic order notifications to Telegram",
        howToSetup: "How to Setup Telegram Bot",
        step1Telegram: "Open Telegram and search for @BotFather",
        step2Telegram: "Send command: /newbot",
        step3Telegram: "Follow instructions and get Bot Token",
        step4Telegram: "Create a Telegram group and add your bot to the group",
        step5Telegram: "Send a message in the group, then open link update",
        step6Telegram: "Look for \"chat\":{\"id\":-1234567890} - that's your Chat ID!",
        botToken: "Bot Token",
        botTokenHint: "Token from @BotFather",
        chatId: "Chat ID",
        chatIdHint: "Group or chat Telegram ID",
        testConnection: "Test Connection",
        saveSettings: "Save Settings",
        telegramStatusInfo: "Status: Telegram not configured yet",
        googleSheet: "Google Sheet",
        googleSheetSettings: "Google Sheet Settings",
        googleSheetSubtitle: "Save orders automatically to Google Sheets",
        howToSetupSheet: "How to Setup Google Sheet",
        step1Sheet: "Open Google Sheets and create a new spreadsheet",
        step2Sheet: "Click Extensions  Apps Script",
        step3Sheet: "Delete existing code, copy the code below and paste",
        step4Sheet: "Click Deploy  New deployment",
        step5Sheet: "Choose Web app, set \"Execute as: Me\" and \"Who has access: Anyone\"",
        step6Sheet: "Click Deploy, copy Web app URL and paste below",
        appsScriptCode: "Apps Script Code (Copy & Paste)",
        copyCode: "Copy Code",
        webAppUrl: "Web App URL",
        webAppUrlHint: "URL from Google Apps Script deployment",
        googleSheetStatusInfo: "Status: Google Sheet not configured yet",
        totalRevenue: "Total Revenue",
        totalOrders: "Total Orders",
        completedOrders: "Paid",
        pendingOrders: "New",
        statusAnalytics: "Order Status Analytics",
        settings: "Settings",
        deleteSelected: "Delete Selected",
        logs: "Logs",
        logTime: "Time",
        logAction: "Action",
        logDetails: "Details"
      }
    };

    let currentLang = 'ms';
    // ... switchLanguage, firebase config ...

    function switchLanguage(lang) {
      currentLang = lang;
      
      document.getElementById('langMs').classList.toggle('active', lang === 'ms');
      document.getElementById('langEn').classList.toggle('active', lang === 'en');
      
      document.querySelectorAll('[data-lang]').forEach(element => {
        const key = element.getAttribute('data-lang');
        if (translations[lang][key]) {
          element.textContent = translations[lang][key];
        }
      });

      if (lang === 'ms') {
        document.getElementById('headerTitle').textContent = 'Kedai Buku Sekolah';
        document.getElementById('headerSubtitle').textContent = 'Sistem Jualan Buku Sekolah';
      } else {
        document.getElementById('headerTitle').textContent = 'School Book Shop';
        document.getElementById('headerSubtitle').textContent = 'School Book Shop System';
      }

      const classSelect = document.getElementById('studentClass');
      if (classSelect && classSelect.options.length > 0) {
        classSelect.options[0].text = translations[lang].selectClass;
      }

      const packageSelect = document.getElementById('packageSelect');
      if (packageSelect && packageSelect.options.length > 0) {
        packageSelect.options[0].text = translations[lang].selectPackage;
      }

      const paymentSelect = document.getElementById('paymentMethod');
      if (paymentSelect) {
        paymentSelect.options[0].text = translations[lang].cash;
        paymentSelect.options[1].text = translations[lang].online;
      }
    }

    // Default Firebase Config
    const defaultFirebaseConfig = {
      apiKey: "AIzaSyCtELiZ5eJUCoC1IaGAYIxkpaEZcE5qN2E",
      authDomain: "eshop-1eb35.firebaseapp.com",
      projectId: "eshop-1eb35",
      storageBucket: "eshop-1eb35.firebasestorage.app",
      messagingSenderId: "719382903072",
      appId: "1:719382903072:web:43b3cfa66411347c567f45",
      measurementId: "G-VF6GTQHHMZ"
    };

    function getFirebaseConfig() {
      const savedConfig = localStorage.getItem('customFirebaseConfig');
      return savedConfig ? JSON.parse(savedConfig) : defaultFirebaseConfig;
    }

    let db;
    const firebaseConfig = getFirebaseConfig();
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (error) {
      console.error("Firebase init error:", error);
    }

    let allItems = [];
    let allPackages = [];
    let allClasses = [];
    let allFees = [];
    let cart = {}; // Shared cart for Items AND Fees
    let currentEditItemId = null;
    let currentEditFeeId = null;
    let currentOrderData = {};
    let loadedOrders = {}; // Cache for admin orders
    let foundOrdersMap = {}; // NEW: Cache for user status search
    let adminOrdersData = []; // Store fetched orders for client-side filtering

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>${message}`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // --- MODAL & CONFIRMATION LOGIC ---
    let confirmCallback = null;
    
    function showConfirm(msg, callback) {
        document.getElementById('confirmMessage').textContent = msg;
        document.getElementById('confirmationModal').classList.remove('hidden');
        document.getElementById('confirmationModal').classList.add('flex'); // Ensure flex is added
        confirmCallback = callback;
    }

    function closeConfirm() {
        document.getElementById('confirmationModal').classList.add('hidden');
        document.getElementById('confirmationModal').classList.remove('flex');
        confirmCallback = null;
    }

    function executeConfirm() {
        if(confirmCallback) confirmCallback();
        closeConfirm();
    }
    // ------------------------------------------

    // Helper: Generate Short ID
    function generateShortId() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let result = '';
        for (let i = 0; i < 4; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    function showSection(sectionId) {
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => section.classList.remove('active'));
      const targetSection = document.getElementById(sectionId);
      if (targetSection) targetSection.classList.add('active');
    }
    
    // ... existing navigation functions ...
    function proceedToStep2() {
      const parentName = document.getElementById('parentName').value.trim();
      const parentPhone = document.getElementById('parentPhone').value.trim();
      const parentEmail = document.getElementById('parentEmail').value.trim();
      const studentName = document.getElementById('studentName').value.trim();
      const studentClass = document.getElementById('studentClass').value;

      if (!parentName || !parentPhone || !parentEmail || !studentName || !studentClass) {
        showToast(currentLang === 'ms' ? 'Sila isi semua ruangan' : 'Please fill in all fields', 'error');
        return;
      }

      currentOrderData = { parentName, parentPhone, parentEmail, studentName, studentClass };
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').classList.remove('hidden');
      loadItemsForShopping();
    }

    function backToStep1() {
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step1').style.display = 'block';
    }

    function proceedToStep3() {
      const cartKeys = Object.keys(cart);
      if (cartKeys.length === 0) {
        showToast(currentLang === 'ms' ? 'Troli masih kosong' : 'Cart is empty', 'info');
      }
      
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.remove('hidden');
      loadFeesForShopping();
      updateCartDisplay(); 
    }

    function backToStep2() {
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      updateCartDisplay();
    }
    
    // ... existing load functions ...
    async function loadClasses() {
      try {
        const doc = await db.collection('settings').doc('book_classes').get();
        allClasses = doc.exists && doc.data().list ? doc.data().list : [];
        const classSelect = document.getElementById('studentClass');
        classSelect.innerHTML = `<option value="">${translations[currentLang].selectClass}</option>`;
        allClasses.forEach(c => classSelect.innerHTML += `<option value="${c}">${c}</option>`);
        updateClassesList();
      } catch (error) { console.error("Error loading classes", error); }
    }

    async function loadItems() {
      try {
        const snap = await db.collection('book_items').get();
        allItems = [];
        snap.forEach(d => allItems.push({ id: d.id, ...d.data() }));
        allItems.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      } catch (error) { console.error("Error loading items", error); }
    }

    async function loadPackages() {
      try {
        const snap = await db.collection('book_packages').get();
        allPackages = [];
        snap.forEach(d => allPackages.push({ id: d.id, ...d.data() }));
        allPackages.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        updatePackageSelector();
      } catch (error) { console.error("Error loading packages", error); }
    }

    async function loadFees() {
      try {
        const snap = await db.collection('pibg_fees').get();
        allFees = [];
        snap.forEach(d => allFees.push({ id: d.id, ...d.data() }));
        allFees.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      } catch (error) { console.error("Error loading fees", error); }
    }

    function updatePackageSelector() {
      const select = document.getElementById('packageSelect');
      select.innerHTML = `<option value="">${translations[currentLang].selectPackage}</option>`;
      allPackages.forEach(p => select.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    }

    function loadItemsForShopping() {
      const tbody = document.getElementById('itemsTableBody');
      tbody.innerHTML = '';
      allItems.forEach(item => {
        const currentQty = cart[item.id] ? cart[item.id].quantity : 0;
        tbody.innerHTML += `
          <tr class="item-row">
            <td class="px-4 py-3 md:py-4 text-gray-800 font-medium">${item.name || 'Unnamed'}</td>
            <td class="px-4 py-3 md:py-4 text-right text-gray-800 font-semibold">${(item.price || 0).toFixed(2)}</td>
            <td class="px-4 py-3 md:py-4 text-center">
              <input type="number" min="0" value="${currentQty}" 
                     class="w-16 md:w-24 px-2 md:px-3 py-1.5 md:py-2 border-2 border-gray-300 rounded-lg text-center font-semibold input-focus focus:ring-2 focus:ring-blue-500 text-sm md:text-base"
                     onchange="updateCartItem('${item.id}', this.value)">
            </td>
          </tr>
        `;
      });
    }

    function loadFeesForShopping() {
      const tbody = document.getElementById('feesTableBody');
      tbody.innerHTML = '';
      allFees.forEach(fee => {
        const isSelected = !!cart[fee.id];
        tbody.innerHTML += `
          <tr class="item-row ${isSelected ? 'bg-green-50' : ''}">
            <td class="px-4 py-3 md:py-4 text-gray-800 font-medium">
              ${fee.name}
              <div class="text-xs text-gray-500">${fee.description || ''}</div>
            </td>
            <td class="px-4 py-3 md:py-4 text-right text-gray-800 font-semibold">${(fee.amount || 0).toFixed(2)}</td>
            <td class="px-4 py-3 md:py-4 text-center">
              <button onclick="toggleFeeInCart('${fee.id}')" 
                      class="px-3 md:px-4 py-1.5 md:py-2 rounded-lg font-bold text-xs md:text-sm transition-all shadow-sm ${isSelected ? 'bg-red-100 text-red-600 hover:bg-red-200' : 'bg-green-100 text-green-600 hover:bg-green-200'}">
                ${isSelected ? '<i class="fas fa-minus mr-1"></i> Remove' : '<i class="fas fa-plus mr-1"></i> Add'}
              </button>
            </td>
          </tr>
        `;
      });
    }

    function toggleFeeInCart(feeId) {
      const fee = allFees.find(f => f.id === feeId);
      if (!fee) return;
      if (cart[feeId]) {
        delete cart[feeId];
      } else {
        cart[feeId] = {
          name: fee.name,
          price: fee.amount,
          quantity: 1,
          type: 'fee'
        };
      }
      loadFeesForShopping();
      updateCartDisplay();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const pkgSelect = document.getElementById('packageSelect');
      if (pkgSelect) {
        pkgSelect.addEventListener('change', (e) => {
          const pkgId = e.target.value;
          if (!pkgId) return;
          const pkg = allPackages.find(p => p.id === pkgId);
          if (!pkg || !pkg.items) return;
          
          const existingFees = {};
          Object.keys(cart).forEach(k => {
            if(cart[k].type === 'fee') existingFees[k] = cart[k];
          });
          cart = { ...existingFees }; 
          pkg.items.forEach(pi => {
            const item = allItems.find(i => i.id === pi.itemId);
            if (item) {
              cart[item.id] = { name: item.name, price: item.price, quantity: pi.qty || 1 };
            }
          });
          loadItemsForShopping();
          updateCartDisplay();
          showToast(currentLang === 'ms' ? 'Pakej dimuatkan!' : 'Package loaded!', 'success');
        });
      }
    });

    function updateCartItem(itemId, quantity) {
      const qty = parseInt(quantity) || 0;
      const item = allItems.find(i => i.id === itemId);
      if (!item) return;
      if (qty > 0) {
        cart[itemId] = { name: item.name, price: item.price, quantity: qty };
      } else {
        delete cart[itemId];
      }
      updateCartDisplay();
    }

    function updateCartDisplay() {
      const containers = ['cartItems2', 'cartItems3'];
      const totalDisplays = document.querySelectorAll('.grandTotalDisplay');

      let total = 0;
      let html = '';

      const cartKeys = Object.keys(cart);
      if (cartKeys.length === 0) {
        html = `<p class="text-gray-500 text-center py-8"><i class="fas fa-shopping-cart text-4xl mb-3 block"></i>${translations[currentLang].noItems}</p>`;
      } else {
        cartKeys.forEach(itemId => {
          const item = cart[itemId];
          const subtotal = item.price * item.quantity;
          total += subtotal;
          const typeLabel = item.type === 'fee' ? `<span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded ml-2">Yuran</span>` : '';
          html += `
            <div class="flex justify-between text-sm mb-3 pb-3 border-b border-gray-200">
              <div class="flex-1 pr-2">
                <div class="font-semibold text-gray-800">${item.name} ${typeLabel}</div>
                <div class="text-gray-600 text-xs mt-1">${item.quantity}  RM ${item.price.toFixed(2)}</div>
              </div>
              <div class="font-bold text-primary">RM ${subtotal.toFixed(2)}</div>
            </div>
          `;
        });
      }

      containers.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
      });

      totalDisplays.forEach(el => {
        el.textContent = total.toFixed(2);
      });
    }

    async function submitOrder() {
      const cartKeys = Object.keys(cart);
      if (cartKeys.length === 0) {
        showToast(currentLang === 'ms' ? 'Sila pilih sekurang-kurangnya satu barang' : 'Please select items', 'error');
        return;
      }

      const paymentMethod = document.getElementById('paymentMethod').value;
      const submitBtn = document.getElementById('submitOrderBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

      let calculatedTotal = 0;
      Object.values(cart).forEach(item => calculatedTotal += (item.price * item.quantity));

      // Generate Short ID
      const shortId = generateShortId();

      try {
        const orderData = {
          ...currentOrderData,
          items: cart,
          paymentMethod,
          total: calculatedTotal,
          status: 'New',
          shortId: shortId, // Add Short ID
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: new Date().toISOString()
        };

        const docRef = await db.collection('book_orders').add(orderData);
        orderData.orderId = docRef.id;

        const pdfBlob = generateInvoicePDF(orderData, true);
        await sendToGoogleSheets(orderData);
        await sendToTelegram(orderData, pdfBlob);

        const successMessage = currentLang === 'ms' ? 'Tempahan Berjaya!' : 'Order Successful!';
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm p-4';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl p-6 md:p-8 max-w-md w-full shadow-2xl animate-bounce-in mx-auto">
            <div class="text-center mb-6">
              <div class="bg-green-100 p-4 rounded-full inline-block mb-4"><i class="fas fa-check-circle text-green-600 text-4xl md:text-5xl"></i></div>
              <h3 class="text-xl md:text-2xl font-bold text-green-700 mb-2">${successMessage}</h3>
            </div>
            <div class="bg-blue-50 rounded-xl p-4 md:p-6 mb-6 border-2 border-blue-200 space-y-3">
              <div class="flex justify-between"><span class="text-sm text-gray-600">ID Tempahan</span><span class="font-bold text-blue-700 font-mono text-lg md:text-xl">${shortId}</span></div>
              <div class="flex justify-between"><span class="text-sm text-gray-600">Jumlah</span><span class="font-bold text-lg md:text-xl text-blue-700">RM ${calculatedTotal.toFixed(2)}</span></div>
            </div>
            <div class="flex flex-col gap-3">
              <button onclick="this.closest('.fixed').remove(); resetOrderForm();" class="w-full px-6 py-3.5 bg-blue-600 text-white rounded-xl font-bold text-sm md:text-base">Tempahan Baru</button>
              <button onclick="this.closest('.fixed').remove(); showSection('statusSection'); document.getElementById('statusPhone').value = '${currentOrderData.parentPhone}';" class="w-full px-6 py-3.5 bg-green-600 text-white rounded-xl font-bold text-sm md:text-base">Semak Status</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

      } catch (error) {
        console.error("Submit error:", error);
        showToast("Error submitting order", 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Hantar Tempahan';
      }
    }

    function generateInvoicePDF(orderData, returnBlob = false) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Use Short ID if available, else standard ID
      const displayId = orderData.shortId || orderData.orderId.substring(0,8);

      doc.setFontSize(20); doc.setTextColor(33, 64, 154); doc.text('KEDAI BUKU SEKOLAH', 105, 20, { align: 'center' });
      doc.setFontSize(10); doc.setTextColor(0,0,0);
      doc.text(`ID: ${displayId}`, 20, 45);
      doc.text(`Parent: ${orderData.parentName}`, 20, 55);
      doc.text(`Student: ${orderData.studentName} (${orderData.studentClass})`, 20, 65);

      const tableData = [];
      Object.keys(orderData.items).forEach(k => {
        const i = orderData.items[k];
        const displayName = i.type === 'fee' ? `[YURAN] ${i.name}` : i.name;
        tableData.push([displayName, i.quantity, `RM ${i.price.toFixed(2)}`, `RM ${(i.price * i.quantity).toFixed(2)}`]);
      });

      doc.autoTable({
        startY: 80,
        head: [['Item/Yuran', 'Qty', 'Price', 'Total']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [33, 64, 154] }
      });
      
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(12); doc.setFont(undefined, 'bold');
      doc.text(`TOTAL: RM ${orderData.total.toFixed(2)}`, 190, finalY, { align: 'right' });

      // STAMP LOGIC
      if (orderData.status === 'Paid') {
          doc.setTextColor(220, 53, 69); // Red color
          doc.setFontSize(30);
          doc.setFont(undefined, 'bold');
          doc.text("TELAH DIBAYAR", 105, 60, { align: 'center', angle: -15 });
          doc.setLineWidth(1);
          doc.setDrawColor(220, 53, 69);
          // Optional box around stamp
          // doc.rect(60, 40, 90, 20); 
      }

      if (returnBlob) return doc.output('blob');
      doc.save(`Invoice_${displayId}.pdf`);
    }

    // ... sendToGoogleSheets, sendToTelegram, resetOrderForm, checkStatus ...
    async function sendToGoogleSheets(data) {
        try {
            const doc = await db.collection('settings').doc('google_sheet_settings').get();
            if(doc.exists && doc.data().webAppUrl) {
                // Use Short ID for google sheet too
                const sheetData = { ...data, orderId: data.shortId || data.orderId, items: data.items };
                await fetch(doc.data().webAppUrl, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(sheetData) });
            }
        } catch(e) { console.error(e); }
    }

    async function sendToTelegram(data, pdfBlob) {
        try {
            const doc = await db.collection('settings').doc('telegram_settings').get();
            if(doc.exists && doc.data().botToken && doc.data().chatId) {
                const { botToken, chatId } = doc.data();
                const displayId = data.shortId || data.orderId.substring(0,8);
                let msg = ` *NEW ORDER*\nID: ${displayId}\nStudent: ${data.studentName}\nTotal: RM ${data.total.toFixed(2)}`;
                
                await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: chatId, text: msg, parse_mode: 'Markdown' })
                });

                const formData = new FormData();
                formData.append('chat_id', chatId);
                formData.append('document', pdfBlob, `Invoice_${displayId}.pdf`);
                await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, { method: 'POST', body: formData });
            }
        } catch(e) { console.error(e); }
    }

    function resetOrderForm() {
      document.getElementById('parentName').value = '';
      document.getElementById('studentName').value = '';
      cart = {};
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step1').style.display = 'block';
      const btn = document.getElementById('submitOrderBtn');
      btn.disabled = false; btn.innerHTML = 'Hantar Tempahan';
      updateCartDisplay();
    }
    
    // Updated checkStatus function
    async function checkStatus() {
        const phone = document.getElementById('statusPhone').value;
        const resDiv = document.getElementById('statusResults');
        resDiv.innerHTML = 'Loading...';
        
        // Clear previous cache
        foundOrdersMap = {};

        const snap = await db.collection('book_orders').where('parentPhone', '==', phone).get();
        if(snap.empty) {
            resDiv.innerHTML = 'Tiada tempahan.'; return;
        }
        
        const statusMap = {
            'New': 'Baru (New)',
            'Processing': 'Dalam Proses (Processing)',
            'Paid': 'Dibayar (Paid)'
        };
        
        let html = '';
        snap.forEach(d => {
            const o = d.data();
            // Cache order data for PDF generation
            foundOrdersMap[d.id] = {id: d.id, ...o};
            
            const displayId = o.shortId || d.id.substring(0,8);
            const displayStatus = statusMap[o.status] || o.status;
            let statusColor = 'text-gray-700';
            if(o.status === 'New') statusColor = 'text-yellow-600';
            if(o.status === 'Processing') statusColor = 'text-blue-600';
            if(o.status === 'Paid') statusColor = 'text-green-600';

            // Check if PAID to show button
            const downloadBtn = o.status === 'Paid' 
                ? `<button onclick="downloadUserReceipt('${d.id}')" class="mt-3 px-4 py-2.5 bg-green-600 text-white rounded-xl text-sm font-bold shadow hover:bg-green-700 transition-all flex items-center justify-center w-full md:w-auto"><i class="fas fa-file-invoice mr-2"></i>Muat Turun Resit</button>` 
                : '';

            html += `<div class="p-4 md:p-5 border rounded-xl mb-3 bg-gray-50 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between mb-2">
                    <span class="font-bold text-gray-800 font-mono text-base md:text-lg">#${displayId}</span>
                    <span class="font-bold ${statusColor} text-sm md:text-base">${displayStatus}</span>
                </div>
                <div class="text-sm text-gray-600 mb-2">Pelajar: <span class="font-semibold">${o.studentName}</span></div>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mt-1 gap-2">
                    <div class="text-sm font-bold text-primary text-base md:text-lg">Total: RM ${o.total.toFixed(2)}</div>
                    ${downloadBtn}
                </div>
            </div>`;
        });
        resDiv.innerHTML = html;
    }

    // New function to handle receipt download
    function downloadUserReceipt(id) {
        const orderData = foundOrdersMap[id];
        if(orderData) {
            generateInvoicePDF(orderData, false);
        } else {
            showToast("Ralat data resit", "error");
        }
    }

    // Toggle Password Visibility Function
    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('adminPassword');
        const toggleIcon = document.getElementById('passwordToggleIcon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }

    // Admin & Auth Logic
    function openAdminLogin() { document.getElementById('adminLoginModal').style.display = 'flex'; }
    function closeAdminLogin() { document.getElementById('adminLoginModal').style.display = 'none'; }
    function closeAdminDashboard() { document.getElementById('adminDashboard').classList.add('hidden'); }
    
    async function verifyAdminLogin() {
        const p = document.getElementById('adminPassword').value;
        const doc = await db.collection('settings').doc('admin_password').get();
        if(!doc.exists) {
            await db.collection('settings').doc('admin_password').set({password: p});
            loadAdminData();
            closeAdminLogin(); document.getElementById('adminDashboard').classList.remove('hidden');
        } else {
            if(doc.data().password === p) {
                loadAdminData();
                closeAdminLogin(); document.getElementById('adminDashboard').classList.remove('hidden');
            } else {
                showToast('Wrong password', 'error');
            }
        }
    }

    function logoutAdmin() {
        closeAdminDashboard();
        showToast("Telah log keluar", "info");
    }

    async function loadAdminData() {
        loadOrders(); loadItemsAdmin(); loadPackagesAdmin(); loadClasses(); loadFeesAdmin();
        loadTelegramSettings(); loadGoogleSheetSettings();
    }

    function showAdminTab(tab) {
        document.querySelectorAll('.admin-tab-content').forEach(d => d.classList.add('hidden'));
        document.getElementById(tab).classList.remove('hidden');
        if(tab === 'ordersTab') loadOrders();
        if(tab === 'feesTab') loadFeesAdmin();
        if(tab === 'analysisTab') loadAnalysisData();
        if(tab === 'logsTab') loadLogs();
    }

    function toggleSelectAll(source, className) {
        document.querySelectorAll('.' + className).forEach(cb => cb.checked = source.checked);
    }
    
    function getSelectedIds(className) {
        return Array.from(document.querySelectorAll('.' + className + ':checked')).map(cb => cb.value);
    }

    // --- LOGGING SYSTEM ---
    async function logActivity(action, details, orderId = null) {
        try {
            await db.collection('system_logs').add({
                action: action,
                details: details,
                orderId: orderId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                date: new Date().toISOString()
            });
        } catch (e) {
            console.error("Log error", e);
        }
    }

    async function loadLogs() {
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = 'Loading...';
        try {
            const snap = await db.collection('system_logs').orderBy('timestamp', 'desc').limit(50).get();
            tbody.innerHTML = '';
            if (snap.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Tiada rekod aktiviti.</td></tr>';
                return;
            }
            snap.forEach(doc => {
                const log = doc.data();
                const timeString = log.date ? new Date(log.date).toLocaleString() : '-';
                const relatedId = log.orderId ? `<span class="bg-gray-100 px-2 py-1 rounded text-xs font-mono text-gray-600">#${log.orderId.substring(0,8)}</span>` : '-';
                
                // Color code actions
                let actionColor = "text-gray-700";
                if(log.action.includes("Delete")) actionColor = "text-red-600 font-bold";
                if(log.action.includes("Status")) actionColor = "text-blue-600 font-bold";

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">${timeString}</td>
                        <td class="px-4 py-3">${relatedId}</td>
                        <td class="px-4 py-3 text-sm ${actionColor}">${log.action}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 min-w-[200px]">${log.details}</td>
                    </tr>
                `;
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = 'Error loading logs.';
        }
    }

    // Order Logic - USING MODAL
    async function loadOrders() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">Loading...</td></tr>';
        
        try {
            const snap = await db.collection('book_orders').orderBy('timestamp', 'desc').limit(100).get();
            adminOrdersData = []; // Clear current data
            
            snap.forEach(d => {
                adminOrdersData.push({ id: d.id, ...d.data() });
            });

            // Populate Class Filter Options
            const filterSelect = document.getElementById('adminClassFilter');
            // Keep "All Classes" option
            filterSelect.innerHTML = '<option value="">Semua Kelas</option>';
            
            const uniqueClasses = [...new Set(adminOrdersData.map(o => o.studentClass))].sort();
            uniqueClasses.forEach(c => {
                if(c) filterSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });

            renderOrders();
        } catch(e) {
            console.error(e);
            tbody.innerHTML = 'Error loading orders.';
        }
    }

    function renderOrders() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        const filterClass = document.getElementById('adminClassFilter').value;
        const searchText = document.getElementById('adminSearchInput').value.toLowerCase();

        // Filter Data
        const filteredOrders = adminOrdersData.filter(o => {
            const matchClass = filterClass ? o.studentClass === filterClass : true;
            const s = searchText;
            const matchSearch = !s || 
                (o.studentName && o.studentName.toLowerCase().includes(s)) ||
                (o.parentName && o.parentName.toLowerCase().includes(s)) ||
                (o.parentPhone && o.parentPhone.includes(s)) ||
                (o.shortId && o.shortId.toLowerCase().includes(s)) ||
                (o.id && o.id.toLowerCase().includes(s));
            
            return matchClass && matchSearch;
        });

        if(filteredOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Tiada tempahan dijumpai.</td></tr>';
            return;
        }

        filteredOrders.forEach(o => {
            let statusColor = 'text-gray-600';
            if(o.status === 'New') statusColor = 'text-yellow-600';
            else if(o.status === 'Processing') statusColor = 'text-blue-600';
            else if(o.status === 'Paid') statusColor = 'text-green-600';

            const displayId = o.shortId || o.id.substring(0,6);

            tbody.innerHTML += `
            <tr class="hover:bg-blue-50 transition-colors cursor-pointer" onclick="viewOrderDetails('${o.id}')">
                <td class="p-3 text-center" onclick="event.stopPropagation()">
                    <input type="checkbox" class="order-checkbox custom-checkbox w-5 h-5" value="${o.id}">
                </td>
                <td class="p-3 font-mono font-bold text-gray-700 whitespace-nowrap">#${displayId}</td>
                <td class="p-3">
                    <div class="font-semibold">${o.studentName}</div>
                    <div class="text-xs text-gray-500">${o.parentName}</div>
                </td>
                <td class="p-3 text-sm whitespace-nowrap">${o.studentClass}</td>
                <td class="p-3 font-bold whitespace-nowrap">RM ${o.total.toFixed(2)}</td>
                <td class="p-3 font-bold ${statusColor} text-xs md:text-sm whitespace-nowrap">${o.status}</td>
                <td class="p-3 flex items-center gap-2" onclick="event.stopPropagation()">
                   <select onchange="updateStatus('${o.id}', this.value)" class="border p-1.5 rounded text-xs md:text-sm bg-white shadow-sm focus:ring-2 focus:ring-blue-500 max-w-[120px]">
                     <option value="New" ${o.status=='New'?'selected':''}>Baru</option>
                     <option value="Processing" ${o.status=='Processing'?'selected':''}>Proses</option>
                     <option value="Paid" ${o.status=='Paid'?'selected':''}>Dibayar</option>
                   </select>
                   <button onclick="deleteOrder('${o.id}')" class="text-red-500 hover:text-red-700 transition-colors p-2" title="Padam"><i class="fas fa-trash"></i></button>
                   <button onclick="printOrderSafe('${o.id}')" class="text-blue-600 hover:text-blue-800 transition-colors p-2" title="Cetak"><i class="fas fa-print"></i></button>
                </td>
            </tr>`;
        });
    }

    function viewOrderDetails(id) {
        const order = adminOrdersData.find(o => o.id === id);
        if(!order) return;

        const content = document.getElementById('orderDetailsContent');
        const displayId = order.shortId || order.id;
        
        let itemsHtml = '<div class="space-y-3">';
        if(order.items) {
            Object.values(order.items).forEach(item => {
                itemsHtml += `
                    <div class="flex justify-between border-b pb-2">
                        <div class="pr-2">
                            <div class="font-medium text-sm md:text-base">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.quantity} x RM ${item.price.toFixed(2)}</div>
                        </div>
                        <div class="font-bold text-sm md:text-base">RM ${(item.quantity * item.price).toFixed(2)}</div>
                    </div>
                `;
            });
        }
        itemsHtml += '</div>';

        content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-gray-500 text-xs">ID Tempahan</p>
                    <p class="font-bold font-mono text-lg text-primary">#${displayId}</p>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-gray-500 text-xs">Tarikh</p>
                    <p class="font-bold">${order.timestamp ? new Date(order.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">Nama Murid</p>
                    <p class="font-bold">${order.studentName}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">Kelas</p>
                    <p class="font-bold">${order.studentClass}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">Nama Ibu Bapa</p>
                    <p class="font-bold">${order.parentName}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">No. Telefon</p>
                    <p class="font-bold">${order.parentPhone}</p>
                </div>
            </div>
            
            <h4 class="font-bold text-gray-700 mb-2">Senarai Barang</h4>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                ${itemsHtml}
                <div class="flex justify-between mt-4 pt-2 border-t border-gray-300">
                    <span class="font-bold text-base md:text-lg">Jumlah Besar</span>
                    <span class="font-bold text-lg md:text-xl text-primary">RM ${order.total.toFixed(2)}</span>
                </div>
            </div>
            
            <div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg">
                <span class="px-3 py-1 rounded-full bg-white border border-blue-200 text-blue-800 font-bold text-xs md:text-sm shadow-sm">${order.status}</span>
                <span class="text-xs md:text-sm text-gray-600 font-medium">${order.paymentMethod || '-'}</span>
            </div>
        `;

        document.getElementById('orderDetailsModal').classList.remove('hidden');
    }

    function printOrderSafe(id) {
        const order = adminOrdersData.find(o => o.id === id);
        if(order) {
            generateInvoicePDF(order, false);
        }
    }

    async function updateStatus(id, status) {
        await db.collection('book_orders').doc(id).update({status});
        
        // Update local data for immediate reflect without refetch
        const idx = adminOrdersData.findIndex(o => o.id === id);
        if(idx !== -1) adminOrdersData[idx].status = status;

        // LOG ACTIVITY
        await logActivity("Update Status", `Status changed to: ${status}`, id);
        
        showToast('Status updated', 'success');
        renderOrders(); // Re-render local data
    }
    
    async function deleteOrder(id) {
        showConfirm('Adakah anda pasti ingin memadam tempahan ini?', async () => {
            await db.collection('book_orders').doc(id).delete();
            
            // Remove from local data
            adminOrdersData = adminOrdersData.filter(o => o.id !== id);

            // LOG ACTIVITY
            await logActivity("Delete Order", "Order deleted permanently", id);

            renderOrders();
            showToast('Tempahan dipadam', 'success');
        });
    }
    
    async function deleteSelectedOrders() {
        const ids = getSelectedIds('order-checkbox');
        if(ids.length === 0) return showToast('Sila pilih sekurang-kurangnya satu tempahan', 'error');
        showConfirm(`Adakah anda pasti ingin memadam ${ids.length} tempahan terpilih?`, async () => {
            await Promise.all(ids.map(id => db.collection('book_orders').doc(id).delete()));
            
            // Remove from local data
            adminOrdersData = adminOrdersData.filter(o => !ids.includes(o.id));

            // LOG ACTIVITY
            await logActivity("Batch Delete", `${ids.length} orders deleted`, "Multiple");

            renderOrders();
            showToast(`${ids.length} tempahan dipadam`, 'success');
        });
    }

    // Analysis Logic
    async function loadAnalysisData() {
        const snap = await db.collection('book_orders').get();
        let total = 0, count = 0, paid = 0, processing = 0, pending = 0;
        snap.forEach(d => {
            const o = d.data();
            total += o.total; count++;
            if(o.status === 'New') pending++;
            else if(o.status === 'Processing') processing++;
            else if(o.status === 'Paid') paid++;
        });
        
        document.getElementById('anaTotalRevenue').innerText = `RM ${total.toFixed(2)}`;
        document.getElementById('anaTotalOrders').innerText = count;
        document.getElementById('anaCompletedOrders').innerText = paid; 
        document.getElementById('anaPendingOrders').innerText = pending; 

        document.getElementById('statNewCount').innerText = pending;
        document.getElementById('barNew').style.width = count > 0 ? `${(pending/count)*100}%` : '0%';
        
        document.getElementById('statProcessingCount').innerText = processing;
        document.getElementById('barProcessing').style.width = count > 0 ? `${(processing/count)*100}%` : '0%';
        
        document.getElementById('statPaidCount').innerText = paid;
        document.getElementById('barPaid').style.width = count > 0 ? `${(paid/count)*100}%` : '0%';
    }

    // Item Logic - USING MODAL
    async function addItem() {
        const name = document.getElementById('newItemName').value;
        const price = parseFloat(document.getElementById('newItemPrice').value);
        if(name && price) {
            await db.collection('book_items').add({name, price});
            hideAddItemForm(); loadItemsAdmin(); loadItems();
        }
    }
    
    async function loadItemsAdmin() {
        const b = document.getElementById('itemsAdminTableBody');
        b.innerHTML = '';
        allItems.forEach(i => {
            b.innerHTML += `<tr>
            <td class="p-3 text-center"><input type="checkbox" class="item-checkbox custom-checkbox" value="${i.id}"></td>
            <td class="p-3">${i.name}</td>
            <td class="p-3 text-right">${i.price.toFixed(2)}</td>
            <td class="p-3 text-center"><button onclick="deleteItem('${i.id}')" class="text-red-500 hover:text-red-700 transition-colors"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }
    
    async function deleteItem(id) { 
        showConfirm('Adakah anda pasti ingin memadam barang ini?', async () => {
             await db.collection('book_items').doc(id).delete(); 
             loadItemsAdmin(); loadItems(); 
             showToast('Barang dipadam', 'success');
        });
    }
    
    async function deleteSelectedItems() {
        const ids = getSelectedIds('item-checkbox');
        if(ids.length === 0) return showToast('Sila pilih barang', 'error');
        showConfirm(`Adakah anda pasti ingin memadam ${ids.length} barang terpilih?`, async () => {
            await Promise.all(ids.map(id => db.collection('book_items').doc(id).delete()));
            loadItemsAdmin(); loadItems();
            showToast('Barang terpilih dipadam', 'success');
        });
    }

    // Fee Logic - USING MODAL
    async function addFee() {
        const name = document.getElementById('newFeeName').value;
        const amount = parseFloat(document.getElementById('newFeeAmount').value);
        const desc = document.getElementById('newFeeDescription').value;
        if(name && amount) {
            await db.collection('pibg_fees').add({name, amount, description: desc});
            hideAddFeeForm(); loadFeesAdmin(); loadFees();
        }
    }

    async function loadFeesAdmin() {
        const b = document.getElementById('feesAdminTableBody');
        b.innerHTML = '';
        allFees.forEach(f => {
            b.innerHTML += `<tr>
            <td class="p-3 text-center"><input type="checkbox" class="fee-checkbox custom-checkbox" value="${f.id}"></td>
            <td class="p-3">${f.name}</td><td class="p-3 text-right">${f.amount.toFixed(2)}</td><td class="p-3">${f.description}</td>
            <td class="p-3 text-center"><button onclick="deleteFee('${f.id}')" class="text-red-500 hover:text-red-700 transition-colors"><i class="fas fa-trash"></i></button></td></tr>`;
        });
    }
    async function deleteFee(id) { 
        showConfirm('Adakah anda pasti ingin memadam yuran ini?', async () => {
             await db.collection('pibg_fees').doc(id).delete(); 
             loadFeesAdmin(); loadFees(); 
             showToast('Yuran dipadam', 'success');
        });
    }
    async function deleteSelectedFees() {
        const ids = getSelectedIds('fee-checkbox');
        if(ids.length === 0) return showToast('Sila pilih yuran', 'error');
        showConfirm(`Adakah anda pasti ingin memadam ${ids.length} yuran terpilih?`, async () => {
            await Promise.all(ids.map(id => db.collection('pibg_fees').doc(id).delete()));
            loadFeesAdmin(); loadFees();
            showToast('Yuran terpilih dipadam', 'success');
        });
    }

    // Package Logic - USING MODAL
    function loadPackagesAdmin() {
       const container = document.getElementById('packagesListContainer');
       if(!container) return;
       container.innerHTML = '';
       allPackages.forEach(p => {
          let itemsHtml = '';
          if(p.items) {
             p.items.forEach(pi => {
                const item = allItems.find(i => i.id === pi.itemId);
                if(item) itemsHtml += `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1">${item.name} (${pi.qty})</span>`;
             });
          }
          
          container.innerHTML += `
            <div class="bg-white p-4 rounded-xl border-2 border-gray-100 mb-3 shadow-sm flex items-start gap-3">
               <input type="checkbox" class="package-checkbox custom-checkbox mt-1" value="${p.id}">
               <div class="flex-1">
                  <div class="flex justify-between items-start">
                      <div>
                         <h4 class="font-bold text-lg text-primary">${p.name}</h4>
                         <div class="flex flex-wrap gap-2 mt-2">${itemsHtml}</div>
                      </div>
                      <button onclick="deletePackage('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors"><i class="fas fa-trash"></i></button>
                  </div>
               </div>
            </div>
          `;
       });
       
       const list = document.getElementById('packageItemsList');
       if(list) {
         list.innerHTML = '';
         allItems.forEach(i => {
            list.innerHTML += `
               <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                  <input type="checkbox" class="package-item-checkbox form-checkbox h-4 w-4 text-blue-600 rounded" value="${i.id}">
                  <span class="ml-2 text-sm text-gray-700">${i.name} - RM${i.price.toFixed(2)}</span>
                  <input type="number" min="1" value="1" class="package-item-qty ml-auto w-16 px-2 py-1 border rounded text-xs" onclick="event.stopPropagation()">
               </label>
            `;
         });
       }
    }

    async function addPackage() {
       const name = document.getElementById('newPackageName').value;
       if(!name) { showToast('Enter package name', 'error'); return; }
       
       const selectedItems = [];
       document.querySelectorAll('.package-item-checkbox:checked').forEach(cb => {
          const row = cb.closest('label');
          const qty = parseInt(row.querySelector('.package-item-qty').value) || 1;
          selectedItems.push({ itemId: cb.value, qty });
       });
       
       if(selectedItems.length === 0) { showToast('Select at least one item', 'error'); return; }
       
       await db.collection('book_packages').add({ name, items: selectedItems });
       hideAddPackageForm();
       loadPackages(); loadPackagesAdmin();
       showToast('Package added', 'success');
    }

    async function deletePackage(id) {
       showConfirm('Adakah anda pasti ingin memadam pakej ini?', async () => {
           await db.collection('book_packages').doc(id).delete();
           loadPackages(); loadPackagesAdmin();
           showToast('Package deleted', 'success');
       });
    }
    
    async function deleteSelectedPackages() {
        const ids = getSelectedIds('package-checkbox');
        if(ids.length === 0) return showToast('Sila pilih pakej', 'error');
        showConfirm(`Adakah anda pasti ingin memadam ${ids.length} pakej terpilih?`, async () => {
            await Promise.all(ids.map(id => db.collection('book_packages').doc(id).delete()));
            loadPackages(); loadPackagesAdmin();
            showToast('Pakej terpilih dipadam', 'success');
        });
    }

    // UI Helpers
    function showAddPackageForm() { document.getElementById('addPackageForm').classList.remove('hidden'); }
    function hideAddPackageForm() { document.getElementById('addPackageForm').classList.add('hidden'); }
    function showAddItemForm() { document.getElementById('addItemForm').classList.remove('hidden'); }
    function hideAddItemForm() { document.getElementById('addItemForm').classList.add('hidden'); }
    function showAddFeeForm() { document.getElementById('addFeeForm').classList.remove('hidden'); }
    function hideAddFeeForm() { document.getElementById('addFeeForm').classList.add('hidden'); }
    
    // Class Logic - USING MODAL
    function updateClassesList() {
      const container = document.getElementById('classesListContainer');
      if (!container) return;
      container.innerHTML = '';
      allClasses.forEach(c => {
        container.innerHTML += `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
            <span class="font-medium text-gray-700">${c}</span>
            <button onclick="deleteClass('${c}')" class="text-red-500 hover:text-red-700 transition-colors">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      });
    }
    async function addClass() {
      const input = document.getElementById('newClassName');
      const name = input.value.trim();
      if (!name) return;
      if (allClasses.includes(name)) { showToast('Class already exists', 'error'); return; }
      const newList = [...allClasses, name].sort();
      await db.collection('settings').doc('book_classes').set({ list: newList });
      input.value = ''; loadClasses(); showToast('Class added', 'success');
    }
    async function deleteClass(name) {
      showConfirm('Adakah anda pasti?', async () => {
          const newList = allClasses.filter(c => c !== name);
          await db.collection('settings').doc('book_classes').set({ list: newList });
          loadClasses(); showToast('Class deleted', 'success');
      });
    }

    // ... saveTelegramSettings, etc ...
    async function saveTelegramSettings() {
        await db.collection('settings').doc('telegram_settings').set({
            botToken: document.getElementById('telegramBotToken').value,
            chatId: document.getElementById('telegramChatId').value
        });
        showToast('Settings Saved', 'success');
    }
    async function loadTelegramSettings() {
        const d = await db.collection('settings').doc('telegram_settings').get();
        if(d.exists) {
            document.getElementById('telegramBotToken').value = d.data().botToken;
            document.getElementById('telegramChatId').value = d.data().chatId;
            document.getElementById('telegramStatus').innerText = 'Configured ';
            document.getElementById('telegramStatusMain').innerText = 'Configured ';
        }
    }
    async function saveGoogleSheetSettings() {
        await db.collection('settings').doc('google_sheet_settings').set({
            webAppUrl: document.getElementById('googleSheetUrl').value
        });
        showToast('Settings Saved', 'success');
    }
    async function loadGoogleSheetSettings() {
        const d = await db.collection('settings').doc('google_sheet_settings').get();
        if(d.exists && d.data().webAppUrl) {
            document.getElementById('googleSheetUrl').value = d.data().webAppUrl;
            document.getElementById('googleSheetStatus').innerText = 'Configured ';
            document.getElementById('googleSheetStatusMain').innerText = 'Configured ';
        }
    }
    function copyAppsScriptCode() {
        navigator.clipboard.writeText(document.getElementById('appsScriptCode').value);
        showToast('Code copied', 'success');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadClasses(); await loadItems(); await loadPackages(); await loadFees();
    });
  </script>
</body>
</html>
