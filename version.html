<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistem Kedai Buku Sekolah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2563eb;
      --secondary-color: #1e40af;
      --bg-admin: #f3f4f6;
    }
    body {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      background-color: #f8fafc;
      overflow-x: hidden;
    }
    @media (max-width: 768px) {
        body { overscroll-behavior-y: none; }
    }

    /* FIX: Specific class to force hide elements toggled by JS */
    .force-hidden { display: none !important; }

    /* Animasi */
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #999; }

    /* Admin Sidebar Active State */
    .nav-item.active {
        background-color: #eff6ff;
        color: #2563eb;
        border-right: 4px solid #2563eb;
    }

    /* Toast Notification */
    .toast {
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      padding: 12px 24px; border-radius: 8px; color: white;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease-out; font-size: 14px;
    }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .toast.info { background: #3b82f6; }

    /* Mobile Specific Optimizations */
    @media (max-width: 768px) {
        .mobile-screen-height {
            min-height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
        }
        .sticky-bottom-btn {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 12px;
            border-top: 1px solid #f3f4f6;
            z-index: 20;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        input, select { font-size: 16px !important; }
    }

    /* Stepper Styling */
    .step-dot {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
  </style>
 </head>
 <body class="text-gray-800 bg-gray-50">

  <!-- ======================= HEADER ======================= -->
  <header id="publicHeader" class="bg-blue-900 text-white shadow-md sticky top-0 z-30 transition-all duration-300">
   <div class="container mx-auto px-4 py-3 md:py-4">
    <div class="flex justify-between items-center">
     <div class="flex items-center gap-3 cursor-pointer" onclick="returnToLandingPage()">
        <div class="bg-white p-1.5 rounded-full shadow-sm">
            <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" alt="Logo" class="w-8 h-8 md:w-10 md:h-10 object-contain">
        </div>
        <div class="leading-tight">
            <h1 class="text-base md:text-xl font-bold uppercase tracking-wide">SK Masjid Tanah</h1>
            <p class="text-[10px] md:text-sm text-blue-200 opacity-90">Sistem Kedai Buku & Yuran</p>
        </div>
     </div>
     <div class="flex items-center gap-2">
        <button onclick="checkAdminStatus()" class="text-[10px] md:text-sm bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-all border border-white/10 flex items-center gap-2">
            <i class="fas fa-user-shield"></i> <span class="hidden md:inline">Admin Panel</span>
        </button>
     </div>
    </div>
   </div>
  </header>

  <!-- ======================= MAIN CONTENT ======================= -->
  <div class="container mx-auto px-4 py-6 min-h-[calc(100vh-80px)] flex flex-col">
   
   <!-- LANDING PAGE -->
   <div id="landingPage" class="flex-1 flex flex-col justify-center items-center animate-fade-in py-8">
      <div class="w-full max-w-4xl mx-auto">
          <div class="text-center mb-10 md:mb-16">
              <h2 class="text-3xl md:text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">Selamat Datang</h2>
              <p class="text-gray-500 text-sm md:text-lg leading-relaxed max-w-xl mx-auto">
                  Sistem pengurusan pembelian buku sekolah dan pembayaran yuran PIBG secara atas talian. Sila pilih urusan anda di bawah.
              </p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
            <!-- 1. Kad Tempahan -->
            <button onclick="openParentPanel()" class="group relative bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:border-blue-500 hover:shadow-xl transition-all text-left flex flex-col h-full overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <div class="relative z-10 mb-6">
                    <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:bg-blue-600 group-hover:text-white transition-colors shadow-sm">
                        <i class="fas fa-shopping-basket"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Mula Tempahan</h3>
                    <p class="text-gray-500 text-sm">Isi borang pembelian buku & bayar yuran sekolah anak anda.</p>
                </div>
                <div class="relative z-10 mt-auto flex items-center text-blue-600 font-bold text-sm group-hover:translate-x-2 transition-transform">
                    Teruskan <i class="fas fa-arrow-right ml-2"></i>
                </div>
            </button>

            <!-- 2. Semak Status -->
            <button onclick="openStatusPanel()" class="group relative bg-white p-8 rounded-2xl shadow-sm border border-gray-100 hover:border-orange-500 hover:shadow-xl transition-all text-left flex flex-col h-full overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-orange-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <div class="relative z-10 mb-6">
                    <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center text-2xl mb-4 group-hover:bg-orange-600 group-hover:text-white transition-colors shadow-sm">
                         <i class="fas fa-search"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Semak Status</h3>
                    <p class="text-gray-500 text-sm">Lihat status tempahan, cetak resit, atau invois terdahulu.</p>
                </div>
                <div class="relative z-10 mt-auto flex items-center text-orange-600 font-bold text-sm group-hover:translate-x-2 transition-transform">
                     Semak Sekarang <i class="fas fa-arrow-right ml-2"></i>
                </div>
            </button>
          </div>
      </div>
      <div class="mt-auto pt-12">
        <p class="text-gray-300 text-[10px] font-mono">&copy; 2024 eKedai Buku v1.0</p>
      </div>
   </div>

   <!-- USER INTERFACE (Parent Dashboard) -->
   <div id="userInterface" class="hidden h-full md:h-auto animate-fade-in">
       
       <!-- Navigasi Ringkas -->
       <div id="stepsHeader" class="flex items-center justify-between mb-4 px-1 max-w-4xl mx-auto pt-2 md:pt-0">
           <button onclick="returnToLandingPage()" class="text-gray-500 text-sm font-medium flex items-center gap-2 hover:text-blue-600 transition-colors bg-white px-3 py-1.5 rounded-lg border border-gray-200 hover:border-blue-200 shadow-sm">
               <i class="fas fa-arrow-left"></i> <span class="hidden md:inline">Halaman Utama</span><span class="md:hidden">Kembali</span>
           </button>
           <div id="pageTitleLabel" class="text-xs md:text-sm font-bold text-blue-600 bg-blue-50 px-4 py-1.5 rounded-lg border border-blue-100">
               Proses Tempahan
           </div>
       </div>

       <!-- STEPPER -->
       <div id="orderStepper" class="max-w-4xl mx-auto mb-8 px-2 hidden">
           <div class="flex justify-between items-center relative">
               <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10 rounded-full"></div>
               <div id="stepperProgress" class="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-blue-600 -z-10 rounded-full transition-all duration-300" style="width: 0%"></div>

               <div class="step-dot active" data-step="1">
                   <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-xs md:text-sm transition-all border-2 bg-blue-600 border-blue-600 text-white shadow-sm">1</div>
                   <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-[10px] font-bold text-blue-600 whitespace-nowrap bg-white px-1">Info</span>
               </div>
               <div class="step-dot" data-step="2">
                   <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-xs md:text-sm transition-all border-2 bg-white border-gray-300 text-gray-400">2</div>
                   <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-[10px] font-medium text-gray-400 whitespace-nowrap bg-white px-1">Pakej</span>
               </div>
               <div class="step-dot" data-step="3">
                   <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-xs md:text-sm transition-all border-2 bg-white border-gray-300 text-gray-400">3</div>
                   <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-[10px] font-medium text-gray-400 whitespace-nowrap bg-white px-1">Extra</span>
               </div>
               <div class="step-dot" data-step="4">
                   <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-xs md:text-sm transition-all border-2 bg-white border-gray-300 text-gray-400">4</div>
                   <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-[10px] font-medium text-gray-400 whitespace-nowrap bg-white px-1">Tag</span>
               </div>
               <div class="step-dot" data-step="5">
                   <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-xs md:text-sm transition-all border-2 bg-white border-gray-300 text-gray-400">5</div>
                   <span class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-[10px] font-medium text-gray-400 whitespace-nowrap bg-white px-1">Bayar</span>
               </div>
           </div>
       </div>

       <!-- Order Section Wrapper -->
       <div id="orderSection" class="max-w-md md:max-w-4xl mx-auto h-full md:h-auto flex flex-col md:block pb-20 md:pb-0">
         
         <!-- Step 1: Maklumat -->
         <div id="step1" class="bg-white rounded-xl shadow-sm border border-gray-100 flex-1 flex flex-col fade-in">
             <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 rounded-t-xl">
                 <h2 class="text-base md:text-lg font-bold text-gray-800 flex items-center gap-2">Maklumat Pelajar</h2>
             </div>
             <div class="p-6 md:p-8 flex-1 overflow-y-auto md:overflow-visible">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Ibu Bapa / Penjaga</label>
                        <input type="text" id="parentName" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all" placeholder="Nama Penuh">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">No. Telefon</label>
                        <input type="tel" id="parentPhone" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all" placeholder="Contoh: 0123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Emel (Pilihan)</label>
                        <input type="email" id="parentEmail" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all" placeholder="nama@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pelajar</label>
                        <input type="text" id="studentName" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none text-sm transition-all" placeholder="Nama Penuh Pelajar">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Kelas</label>
                        <select id="studentClass" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none bg-white text-sm transition-all cursor-pointer">
                            <option value="">-- Pilih Kelas --</option>
                        </select>
                    </div>
                 </div>
             </div>
             <div class="sticky-bottom-btn md:static md:bg-transparent md:border-none md:p-8 md:pt-0 rounded-b-xl md:flex md:justify-end">
                 <button onclick="proceedToStep2()" class="w-full md:w-auto md:px-10 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-semibold shadow-lg hover:shadow-blue-500/30 active:bg-blue-800 flex justify-center items-center gap-2 transition-all transform active:scale-95">
                     Seterusnya <i class="fas fa-arrow-right text-xs"></i>
                 </button>
             </div>
         </div>

         <!-- Step 2: Pakej -->
         <div id="step2" class="hidden flex flex-col h-full md:h-auto bg-white rounded-xl shadow-sm border border-gray-100 fade-in">
             <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <div>
                    <h2 class="text-base md:text-lg font-bold text-gray-800">Pilih Pakej Buku</h2>
                    <p class="hidden md:block text-xs text-gray-500">Sila pilih pakej yang bersesuaian dengan tahun pelajar.</p>
                </div>
                <span class="text-[10px] md:text-xs text-red-600 font-bold bg-red-100 px-3 py-1 rounded-full border border-red-200">*Wajib Pilih Satu</span>
             </div>
             <div class="p-6 md:p-8 flex-1 overflow-y-auto md:overflow-visible">
                 <div id="packagesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
             </div>
             <div class="sticky-bottom-btn md:static md:bg-transparent md:border-none md:p-8 md:pt-0 grid grid-cols-3 md:flex md:justify-end gap-3 rounded-b-xl">
                 <button onclick="backToStep1()" class="col-span-1 md:w-auto md:px-8 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3.5 rounded-xl font-semibold text-sm transition-all">Kembali</button>
                 <button onclick="proceedToStep3()" class="col-span-2 md:w-auto md:px-10 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-blue-500/30 transition-all transform active:scale-95">Seterusnya</button>
             </div>
         </div>

         <!-- Step 3: Barang Tambahan -->
         <div id="step3" class="hidden flex flex-col h-full md:h-auto bg-white rounded-xl shadow-sm border border-gray-100 fade-in">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
               <div>
                   <h2 class="text-base md:text-lg font-bold text-gray-800">Barang Tambahan (Pilihan)</h2>
               </div>
               <p id="step3Total" class="text-sm md:text-xl font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg border border-blue-100">RM 0.00</p>
            </div>
            <div class="flex-1 overflow-y-auto md:overflow-visible p-0 md:p-8">
                <div class="md:border md:rounded-xl md:overflow-hidden md:border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 text-xs md:text-sm font-semibold uppercase tracking-wider sticky top-0 md:static z-10">
                            <tr>
                                <th class="px-6 py-4">Item</th>
                                <th class="px-4 py-4 text-right">Harga</th>
                                <th class="px-6 py-4 text-center w-24 md:w-32">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
            <div class="sticky-bottom-btn md:static md:bg-transparent md:border-none md:p-8 md:pt-0 grid grid-cols-3 md:flex md:justify-end gap-3 rounded-b-xl">
                <button onclick="backToStep2()" class="col-span-1 md:w-auto md:px-8 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3.5 rounded-xl font-semibold text-sm transition-all">Kembali</button>
                <button onclick="proceedToStep4()" class="col-span-2 md:w-auto md:px-10 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-blue-500/30 transition-all transform active:scale-95">Seterusnya</button>
            </div>
         </div>

         <!-- Step 4: Nametag -->
         <div id="step4" class="hidden flex flex-col h-full md:h-auto bg-white rounded-xl shadow-sm border border-gray-100 fade-in">
            <div class="p-8 md:p-16 flex-1 flex flex-col justify-center items-center text-center">
                <div class="w-16 h-16 md:w-24 md:h-24 bg-yellow-50 text-yellow-500 rounded-full flex items-center justify-center mb-6 text-3xl md:text-5xl border-4 border-yellow-100">
                    <i class="fas fa-id-card"></i>
                </div>
                <h2 class="text-xl md:text-3xl font-bold text-gray-800 mb-3">Tempahan Nametag</h2>
                <p class="text-gray-500 text-sm md:text-base mb-8 max-w-lg mx-auto">Masukkan nama pelajar untuk dicetak pada nametag. Maksimum 12 huruf. <br class="hidden md:inline">Biarkan kosong jika tidak memerlukan nametag.</p>
                
                <div class="w-full max-w-md mx-auto">
                    <input type="text" id="nametagInput" maxlength="12" class="w-full text-center text-3xl md:text-5xl font-mono tracking-widest uppercase py-4 border-b-2 border-gray-300 focus:border-blue-500 outline-none bg-transparent mb-3 transition-all placeholder-gray-300" placeholder="ALI BIN ABU">
                    <div class="text-xs md:text-sm text-gray-400 font-medium" id="charCount">0/12</div>
                </div>
            </div>
            <div class="sticky-bottom-btn md:static md:bg-transparent md:border-none md:p-8 md:pt-0 grid grid-cols-3 md:flex md:justify-end gap-3 rounded-b-xl">
                <button onclick="backToStep3()" class="col-span-1 md:w-auto md:px-8 bg-gray-100 hover:bg-gray-200 text-gray-600 py-3.5 rounded-xl font-semibold text-sm transition-all">Kembali</button>
                <button onclick="proceedToStep5()" class="col-span-2 md:w-auto md:px-10 bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-blue-500/30 transition-all transform active:scale-95">Seterusnya</button>
            </div>
         </div>

         <!-- Step 5: Yuran & Bayaran -->
         <div id="step5" class="hidden flex flex-col h-full md:h-auto fade-in">
             <div class="flex-1 md:grid md:grid-cols-3 md:gap-8">
                 <div class="md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col fade-in overflow-hidden mb-4 md:mb-0 h-fit">
                     <div class="flex-1 p-6 space-y-4">
                         <div>
                             <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2 pb-2 border-b"><i class="fas fa-hand-holding-usd text-green-500"></i> Sumbangan PIBG</h3>
                             <div class="rounded-xl border border-gray-200 overflow-hidden">
                                <table class="w-full text-sm"><tbody id="feesTableBody" class="divide-y divide-gray-100"></tbody></table>
                             </div>
                         </div>
                     </div>
                 </div>

                 <div class="md:col-span-1 bg-white md:bg-blue-50 md:border md:border-blue-100 rounded-xl shadow-sm flex flex-col h-full md:h-fit md:sticky md:top-24">
                     <div class="p-6 flex-1 overflow-y-auto">
                        <div class="text-center mb-6 border-b border-gray-200/50 md:border-blue-200 pb-4">
                            <h3 class="font-bold text-gray-800 text-lg">Ringkasan</h3>
                            <p class="text-xs text-gray-500">Semak butiran sebelum sahkan</p>
                        </div>

                         <div id="nametagReview" class="hidden bg-yellow-100 text-yellow-800 text-xs p-3 rounded-lg mb-4 text-center border border-yellow-200 font-bold shadow-sm">
                             NAMETAG: <span id="nametagDisplay"></span>
                         </div>
                         
                         <div id="cartItemsFinal" class="max-h-48 md:max-h-60 overflow-y-auto custom-scrollbar text-sm space-y-3 mb-6 bg-white md:bg-white/50 p-3 rounded-xl border border-gray-100"></div>
                         
                         <div class="flex justify-between items-center pt-4 border-t border-gray-200 md:border-blue-200 mb-6">
                             <span class="font-bold text-gray-600">Jumlah Besar</span>
                             <span class="text-2xl font-bold text-blue-600">RM <span class="grandTotalDisplay">0.00</span></span>
                         </div>

                         <div class="mb-2">
                             <label class="text-xs font-bold text-gray-500 uppercase mb-2 block tracking-wider">Kaedah Bayaran</label>
                             <select id="paymentMethod" class="w-full px-4 py-3 rounded-xl border border-gray-300 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer"></select>
                         </div>
                     </div>

                     <div class="sticky-bottom-btn md:static md:bg-transparent md:border-none md:p-6 md:pt-0 grid grid-cols-3 gap-3 rounded-b-xl">
                         <button onclick="backToStep4()" class="col-span-1 bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 py-3.5 rounded-xl font-bold text-sm transition-all shadow-sm">Ubah</button>
                         <button onclick="submitOrder()" id="submitOrderBtn" class="col-span-2 bg-green-600 hover:bg-green-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-green-500/30 flex justify-center items-center gap-2 text-sm transition-all transform active:scale-95">
                             <i class="fas fa-check-circle"></i> Sahkan Tempahan
                         </button>
                     </div>
                 </div>
             </div>
         </div>
       </div>

       <!-- Status Section Wrapper -->
       <!-- Removed 'section' class -->
       <div id="statusSection" class="max-w-md mx-auto h-full hidden fade-in py-4 md:py-0">
           <div class="bg-white rounded-2xl shadow-sm border border-gray-100 h-full flex flex-col overflow-hidden">
               <div class="p-8 md:p-10 text-center border-b border-gray-100 bg-gray-50">
                   <div class="bg-orange-100 w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-600 text-2xl md:text-4xl shadow-sm"><i class="fas fa-search"></i></div>
                   <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Semakan Status</h2>
                   <p class="text-gray-500 text-sm mb-8 max-w-xs mx-auto">Masukkan nombor telefon ibu bapa/penjaga yang didaftarkan.</p>
                   
                   <div class="flex gap-3 max-w-sm mx-auto">
                       <input type="tel" id="statusPhone" class="flex-1 px-5 py-3.5 rounded-xl border border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-100 outline-none text-center text-lg tracking-wider font-semibold" placeholder="012xxxxxxx">
                       <button onclick="checkStatus()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 rounded-xl font-bold shadow-lg hover:shadow-orange-500/30 transition-all active:scale-95"><i class="fas fa-arrow-right"></i></button>
                   </div>
               </div>
               <div class="flex-1 overflow-y-auto p-6 bg-gray-50/50">
                   <div id="statusResults" class="space-y-4 max-w-lg mx-auto"></div>
               </div>
           </div>
       </div>
   </div>

   <!-- MODALS -->
   <!-- SUCCESS MODAL (Pop-up) -->
   <div id="successModal" class="fixed inset-0 bg-black/50 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm">
       <div class="bg-white rounded-2xl p-6 md:p-8 max-w-sm md:max-w-md w-full shadow-2xl animate-fade-in text-center transform transition-all scale-100">
           <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm"><i class="fas fa-check"></i></div>
           <h2 class="text-2xl font-bold text-gray-900 mb-2">Tempahan Berjaya!</h2>
           <p class="text-gray-600 mb-6 text-sm">ID Tempahan: <span class="font-mono font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 text-base" id="successOrderId"></span></p>
           
           <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6 text-left text-xs md:text-sm text-yellow-800">
                <p class="font-bold flex items-center gap-2 mb-1"><i class="fas fa-exclamation-circle"></i> Info Penting:</p>
                <ul class="list-disc ml-4 space-y-1">
                    <li>Sila cetak atau simpan PDF ini.</li>
                    <li>Tunjukkan PDF kepada guru kelas.</li>
                </ul>
           </div>

           <div class="grid grid-cols-1 gap-3">
               <button onclick="generateInvoicePDF(lastOrderData)" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3.5 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                   <i class="fas fa-print"></i> Cetak / Simpan PDF
               </button>
               <button onclick="finishOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3.5 rounded-xl font-bold shadow-md transition-transform active:scale-95">
                   Selesai
               </button>
           </div>
       </div>
   </div>

   <div id="adminLoginModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
       <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl animate-fade-in text-center">
           <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-lock"></i></div>
           <h2 class="text-xl font-bold mb-6">Akses Admin Sahaja</h2>
           <input type="email" id="adminEmail" class="w-full p-3 border rounded-xl mb-3" placeholder="Emel">
           <div class="relative mb-6">
               <input type="password" id="adminPassword" class="w-full p-3 border rounded-xl pr-10" placeholder="Kata Laluan">
               <button type="button" onclick="toggleAdminPassword()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600 focus:outline-none">
                   <i class="fas fa-eye" id="togglePasswordIcon"></i>
               </button>
           </div>
           <div class="flex gap-2">
               <button onclick="closeAdminLogin()" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-50 rounded-xl">Batal</button>
               <button id="adminLoginBtn" onclick="verifyAdminLogin()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg flex justify-center items-center gap-2">Log Masuk</button>
           </div>
       </div>
   </div>

   <div id="confirmationModal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
       <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl text-center">
           <h3 class="font-bold text-lg mb-2">Pasti?</h3>
           <p id="confirmMessage" class="text-gray-500 mb-6 text-sm">Tindakan ini tidak boleh dikembalikan.</p>
           <div class="flex gap-3">
               <button onclick="closeConfirm()" class="flex-1 py-2 bg-gray-100 rounded-lg font-medium">Batal</button>
               <button onclick="executeConfirm()" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium">Ya, Teruskan</button>
           </div>
       </div>
   </div>

  <div id="orderDetailsModal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white rounded-2xl p-6 max-w-lg w-full shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
          <div class="flex justify-between items-center mb-4 border-b pb-3">
              <h3 class="font-bold text-lg">Butiran Tempahan</h3>
              <button onclick="document.getElementById('orderDetailsModal').classList.add('hidden')" class="w-8 h-8 bg-gray-100 rounded-full hover:bg-gray-200 flex items-center justify-center">&times;</button>
          </div>
          <div id="orderDetailsContent" class="overflow-y-auto flex-1 pr-2 custom-scrollbar text-sm space-y-3"></div>
      </div>
  </div>

  <!-- ADMIN DASHBOARD -->
   <div id="adminDashboard" class="fixed inset-0 bg-gray-100 z-50 hidden flex overflow-hidden">
       <!-- Sidebar -->
       <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col shadow-sm">
           <div class="p-6 border-b border-gray-100 flex items-center gap-3">
               <div class="bg-blue-600 text-white p-2 rounded-lg"><i class="fas fa-shield-alt"></i></div>
               <div class="font-bold text-gray-800 leading-tight">Admin Panel<br><span class="text-xs text-gray-400 font-normal">v2.1 Pro</span></div>
           </div>
           
           <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
               <button onclick="showAdminTab('analysisTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3 active">
                   <i class="fas fa-chart-pie w-5 text-center"></i> Analisis Data
               </button>
               <button onclick="showAdminTab('ordersTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3">
                   <i class="fas fa-receipt w-5 text-center"></i> Tempahan
               </button>
               <button onclick="showAdminTab('itemsTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3">
                   <i class="fas fa-box w-5 text-center"></i> Inventori Barang
               </button>
               <button onclick="showAdminTab('packagesTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3">
                   <i class="fas fa-cubes w-5 text-center"></i> Pakej
               </button>
               <button onclick="showAdminTab('feesTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3">
                   <i class="fas fa-hand-holding-usd w-5 text-center"></i> Yuran PIBG
               </button>
               <button onclick="showAdminTab('classesTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3">
                   <i class="fas fa-school w-5 text-center"></i> Senarai Kelas
               </button>
               <button onclick="showAdminTab('settingsTab')" class="nav-item w-full text-left px-4 py-3 rounded-xl text-gray-600 font-medium hover:bg-gray-50 transition-all flex items-center gap-3">
                   <i class="fas fa-cog w-5 text-center"></i> Tetapan Sistem
               </button>
           </nav>
           <div class="p-4 border-t border-gray-100">
               <button onclick="logoutAdmin()" class="w-full px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 font-semibold transition-all flex items-center justify-center gap-2">
                   <i class="fas fa-sign-out-alt"></i> Log Keluar
               </button>
           </div>
       </aside>

       <!-- Main Admin Content -->
       <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-[#f3f4f6]">
           <!-- Topbar Mobile Toggle -->
           <div class="bg-white border-b border-gray-200 p-4 flex md:hidden justify-between items-center shadow-sm">
               <span class="font-bold text-gray-800">Admin Panel</span>
               <button onclick="logoutAdmin()" class="text-red-500"><i class="fas fa-sign-out-alt"></i></button>
           </div>
           
           <!-- Content Area -->
           <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
               
               <!-- 1. ANALYSIS DASHBOARD -->
               <div id="analysisTab" class="admin-tab-content fade-in">
                   <div class="mb-6">
                       <h2 class="text-2xl font-bold text-gray-800">Analisis Prestasi</h2>
                       <p class="text-gray-500 text-sm">Ringkasan jualan dan tempahan terkini.</p>
                   </div>
                   <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                           <span class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Jumlah Jualan</span>
                           <span class="text-3xl font-bold text-gray-900 mb-2">RM <span id="statRevenue">0</span></span>
                           <div class="h-1 w-full bg-green-100 rounded-full"><div class="h-1 bg-green-500 rounded-full" style="width: 70%"></div></div>
                       </div>
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                           <span class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Bil. Tempahan</span>
                           <span class="text-3xl font-bold text-gray-900 mb-2"><span id="statOrders">0</span></span>
                           <div class="h-1 w-full bg-blue-100 rounded-full"><div class="h-1 bg-blue-500 rounded-full" style="width: 45%"></div></div>
                       </div>
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                           <span class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Sudah Bayar</span>
                           <span class="text-3xl font-bold text-green-600 mb-2"><span id="statPaid">0</span></span>
                           <span class="text-xs text-gray-400">Transaksi Selesai</span>
                       </div>
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                           <span class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Belum Bayar</span>
                           <span class="text-3xl font-bold text-yellow-600 mb-2"><span id="statUnpaid">0</span></span>
                           <span class="text-xs text-gray-400">Menunggu Tindakan</span>
                       </div>
                   </div>
                   <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                       <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                           <h3 class="font-bold text-gray-800 mb-4">Pecahan Jualan Mengikut Kelas</h3>
                           <div id="classSalesChart" class="space-y-4">
                               <div class="text-center text-gray-400 py-10">Memuatkan Data...</div>
                           </div>
                       </div>
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                           <h3 class="font-bold text-gray-800 mb-4">Aktiviti Terkini</h3>
                           <div id="recentActivityLog" class="space-y-3 text-sm"></div>
                       </div>
                   </div>
               </div>

               <!-- 2. INVENTORY ITEMS -->
               <div id="itemsTab" class="admin-tab-content hidden fade-in">
                   <div class="flex justify-between items-center mb-6">
                       <div>
                           <h2 class="text-2xl font-bold text-gray-800">Inventori Barang</h2>
                           <p class="text-gray-500 text-sm">Uruskan senarai buku dan alat tulis.</p>
                       </div>
                       <button onclick="showAddItemForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold shadow-md flex items-center gap-2">
                           <i class="fas fa-plus"></i> Tambah Barang
                       </button>
                   </div>
                   <div id="addItemForm" class="hidden bg-white p-6 rounded-2xl shadow-lg border border-gray-100 mb-6 animate-fade-in">
                       <h4 class="font-bold text-gray-700 mb-4">Tambah Barang Baru</h4>
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                           <input id="newItemName" placeholder="Nama Barang (Contoh: Buku Tulis Garis Satu)" class="px-4 py-2 border rounded-lg w-full">
                           <input id="newItemPrice" type="number" placeholder="Harga (RM)" class="px-4 py-2 border rounded-lg w-full">
                       </div>
                       <div class="flex gap-2 justify-end">
                           <button onclick="hideAddItemForm()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">Batal</button>
                           <button onclick="addItem()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold">Simpan</button>
                       </div>
                   </div>
                   <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                       <table class="w-full text-left border-collapse">
                           <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
                               <tr>
                                   <th class="p-4 border-b">Nama Barang</th>
                                   <th class="p-4 border-b text-right">Harga (RM)</th>
                                   <th class="p-4 border-b text-center">Tindakan</th>
                               </tr>
                           </thead>
                           <tbody id="itemsAdminTableBody" class="divide-y divide-gray-100 text-sm text-gray-700">
                               <tr><td colspan="3" class="p-6 text-center text-gray-400">Memuatkan...</td></tr>
                           </tbody>
                       </table>
                   </div>
               </div>

               <!-- 3. ORDERS -->
               <div id="ordersTab" class="admin-tab-content hidden fade-in">
                   <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                       <div class="p-4 border-b border-gray-100 flex flex-col md:flex-row justify-between gap-4 bg-gray-50/50">
                           <div class="relative flex-1 max-w-md">
                               <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                               <input id="adminSearchInput" onkeyup="renderOrders()" placeholder="Cari Pelajar / ID..." class="pl-10 pr-4 py-2.5 w-full rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-100 outline-none">
                           </div>
                           <div class="flex gap-2">
                               <select id="adminClassFilter" onchange="renderOrders()" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-white text-sm">
                                   <option value="">Semua Kelas</option>
                               </select>
                               <button onclick="deleteSelectedOrders()" class="px-4 py-2.5 bg-white border border-red-200 text-red-600 rounded-xl hover:bg-red-50 transition-colors text-sm font-bold">
                                   <i class="fas fa-trash-alt"></i>
                               </button>
                           </div>
                       </div>
                       <div class="overflow-x-auto">
                           <table class="w-full text-sm text-left">
                               <thead class="bg-gray-50 text-gray-600 font-semibold border-b">
                                   <tr>
                                       <th class="p-4 w-10 text-center"><input type="checkbox" onchange="toggleSelectAll(this, 'order-checkbox')" class="rounded border-gray-300"></th>
                                       <th class="p-4">ID / Tarikh</th>
                                       <th class="p-4">Pelajar</th>
                                       <th class="p-4">Kelas</th>
                                       <th class="p-4">Jumlah</th>
                                       <th class="p-4">Status</th>
                                       <th class="p-4 text-center">Tindakan</th>
                                   </tr>
                               </thead>
                               <tbody id="ordersTableBody" class="divide-y divide-gray-100"></tbody>
                           </table>
                       </div>
                   </div>
               </div>

               <!-- 4. OTHER TABS -->
               <div id="packagesTab" class="admin-tab-content hidden fade-in">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Urus Pakej</h2>
                            <button onclick="showAddPackageForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Tambah Pakej</button>
                        </div>
                        <div id="addPackageForm" class="hidden bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200">
                             <input id="newPackageName" placeholder="Nama Pakej" class="w-full p-2 border rounded mb-2">
                             <div class="max-h-40 overflow-y-auto bg-white border p-2 mb-2 rounded" id="packageItemsList"></div>
                             <button onclick="addPackage()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Simpan</button>
                             <button onclick="hideAddPackageForm()" class="text-gray-500 px-4 py-2 text-sm">Batal</button>
                        </div>
                        <div id="packagesListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
               </div>
               <div id="feesTab" class="admin-tab-content hidden fade-in">
                   <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                       <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">Yuran PIBG</h2><button onclick="showAddFeeForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Tambah Yuran</button></div>
                       <div id="addFeeForm" class="hidden bg-gray-50 p-4 rounded-xl mb-4 border border-gray-200">
                           <input id="newFeeName" placeholder="Nama Yuran" class="w-full p-2 border rounded mb-2">
                           <input id="newFeeAmount" type="number" placeholder="Jumlah (RM)" class="w-full p-2 border rounded mb-2">
                           <input id="newFeeDescription" placeholder="Deskripsi ringkas" class="w-full p-2 border rounded mb-2">
                           <button onclick="addFee()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Simpan</button>
                           <button onclick="hideAddFeeForm()" class="text-gray-500 px-4 py-2 text-sm">Batal</button>
                       </div>
                       <table class="w-full text-sm"><thead class="bg-gray-50 font-bold text-gray-500"><tr><th class="p-3">Nama</th><th class="p-3 text-right">Jumlah</th><th class="p-3 text-center">Hapus</th></tr></thead><tbody id="feesAdminTableBody" class="divide-y"></tbody></table>
                   </div>
               </div>
               <div id="classesTab" class="admin-tab-content hidden fade-in">
                   <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                       <h2 class="text-xl font-bold mb-4">Senarai Kelas</h2>
                       <div class="flex gap-2 mb-6">
                           <input id="newClassName" placeholder="Nama Kelas Baru" class="flex-1 p-2 border rounded-lg">
                           <button onclick="addClass()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">Tambah</button>
                       </div>
                       <div id="classesListAdmin" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                   </div>
               </div>
               <div id="settingsTab" class="admin-tab-content hidden fade-in">
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                           <h3 class="font-bold mb-4">Integrasi</h3>
                           <div class="space-y-4">
                               <div>
                                   <label class="text-xs font-bold text-gray-500 uppercase">Telegram Bot Token</label>
                                   <input id="telegramBotToken" type="password" class="w-full p-2 border rounded mt-1">
                               </div>
                               <div>
                                   <label class="text-xs font-bold text-gray-500 uppercase">Chat ID</label>
                                   <input id="telegramChatId" class="w-full p-2 border rounded mt-1">
                               </div>
                               <button onclick="saveTelegramSettings()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm w-full">Simpan Telegram</button>
                           </div>
                       </div>
                       <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                           <h3 class="font-bold mb-4">Pembayaran</h3>
                           <div class="space-y-3">
                               <label class="flex items-center gap-2 border p-3 rounded cursor-pointer hover:bg-gray-50">
                                   <input type="checkbox" id="toggleCash"> <span class="font-medium">Benarkan Tunai (Cash)</span>
                               </label>
                               <label class="flex items-center gap-2 border p-3 rounded cursor-pointer hover:bg-gray-50">
                                   <input type="checkbox" id="toggleOnline"> <span class="font-medium">Benarkan Online Transfer</span>
                               </label>
                               <button onclick="savePaymentSettings()" class="bg-green-600 text-white px-4 py-2 rounded text-sm w-full mt-2">Simpan Tetapan Bayaran</button>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </main>
   </div>

  <script>
    // --- CORE LOGIC (Firebase & Data) ---
    const defaultFirebaseConfig = {
      apiKey: "AIzaSyCtELiZ5eJUCoC1IaGAYIxkpaEZcE5qN2E",
      authDomain: "eshop-1eb35.firebaseapp.com",
      projectId: "eshop-1eb35",
      storageBucket: "eshop-1eb35.firebasestorage.app",
      messagingSenderId: "719382903072",
      appId: "1:719382903072:web:43b3cfa66411347c567f45",
      measurementId: "G-VF6GTQHHMZ"
    };

    let db, auth;
    try {
      firebase.initializeApp(defaultFirebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
    } catch (error) { console.error("Firebase init error", error); }

    let allItems = [], allPackages = [], allClasses = [], allFees = [], adminOrdersData = [];
    let cart = {}, currentOrderData = {}, selectedPackageId = null;
    let paymentConfig = { cash: true, online: true };
    let telegramConfig = { botToken: '', chatId: '' }; // Global variable for telegram settings
    let lastOrderData = null; 
    let publicStatusData = []; 

    // --- HELPER FUNCTIONS ---
    function showToast(msg, type = 'info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
    
    let confirmCallback = null;
    function showConfirm(msg, cb) {
        document.getElementById('confirmMessage').textContent = msg;
        document.getElementById('confirmationModal').classList.remove('hidden');
        confirmCallback = cb;
    }
    function closeConfirm() { document.getElementById('confirmationModal').classList.add('hidden'); confirmCallback = null; }
    function executeConfirm() { if(confirmCallback) confirmCallback(); closeConfirm(); }

    function showSection(id) {
        // Updated visibility logic using 'force-hidden' to ensure flex containers are hidden properly
        // This prevents the overlap issue seen previously
        const sections = ['orderSection', 'statusSection'];
        
        sections.forEach(secId => {
            const el = document.getElementById(secId);
            if(el) {
                // Add the forceful hidden class to override any flex display
                el.classList.add('force-hidden');
                el.classList.remove('fade-in');
            }
        });

        const target = document.getElementById(id);
        if(target) {
            target.classList.remove('force-hidden');
            target.classList.remove('hidden'); // Also remove standard hidden if present
            target.classList.add('fade-in');
        }
        window.scrollTo(0,0);
    }

    // --- STEPPER LOGIC ---
    function updateStepper(step) {
        document.getElementById('orderStepper').classList.remove('hidden');
        const progress = ((step - 1) / 4) * 100;
        document.getElementById('stepperProgress').style.width = `${progress}%`;
        document.querySelectorAll('.step-dot').forEach(dot => {
            const dotStep = parseInt(dot.getAttribute('data-step'));
            const dotCircle = dot.querySelector('div');
            const dotLabel = dot.querySelector('span');
            if (dotStep <= step) {
                dotCircle.classList.remove('bg-white', 'border-gray-300', 'text-gray-400');
                dotCircle.classList.add('bg-blue-600', 'border-blue-600', 'text-white');
                dotLabel.classList.remove('text-gray-400');
                dotLabel.classList.add('text-blue-600', 'font-bold');
            } else {
                dotCircle.classList.remove('bg-blue-600', 'border-blue-600', 'text-white');
                dotCircle.classList.add('bg-white', 'border-gray-300', 'text-gray-400');
                dotLabel.classList.remove('text-blue-600', 'font-bold');
                dotLabel.classList.add('text-gray-400', 'font-medium');
            }
        });
    }

    function returnToLandingPage() {
        document.getElementById('userInterface').classList.add('hidden');
        document.getElementById('adminDashboard').classList.add('hidden');
        const landing = document.getElementById('landingPage');
        landing.classList.remove('hidden');
        landing.classList.add('animate-fade-in'); 
        window.scrollTo(0,0);
    }

    function openParentPanel() {
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('userInterface').classList.remove('hidden');
        document.getElementById('stepsHeader').classList.remove('hidden');
        document.getElementById('successModal').classList.add('hidden');
        
        // Hide Status, Show Order
        document.getElementById('statusSection').classList.add('force-hidden'); // Use force-hidden
        document.getElementById('orderSection').classList.remove('force-hidden');
        document.getElementById('orderSection').classList.remove('hidden');
        
        showSection('orderSection');
        
        ['step2','step3','step4','step5'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('pageTitleLabel').innerText = "Proses Tempahan";
        updateStepper(1); 
        loadClasses();
        window.scrollTo(0,0);
    }

    function openStatusPanel() {
        document.getElementById('landingPage').classList.add('hidden');
        document.getElementById('userInterface').classList.remove('hidden');
        
        // Hide Order components
        document.getElementById('orderSection').classList.add('force-hidden'); // Use force-hidden
        document.getElementById('orderStepper').classList.add('hidden'); 
        
        // Show Status
        document.getElementById('statusSection').classList.remove('force-hidden');
        document.getElementById('statusSection').classList.remove('hidden');
        showSection('statusSection');
        
        document.getElementById('pageTitleLabel').innerText = "Semakan Status";
        window.scrollTo(0,0);
    }

    // --- GLOBAL PDF GENERATOR (UPDATED FORMAT) ---
    function generateInvoicePDF(orderData, returnBlob = false) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Colors
      const primaryColor = [37, 99, 235]; // Blue-600
      const greenColor = [22, 163, 74];   // Green-600
      const redColor = [220, 38, 38];     // Red-600
      
      const isPaid = orderData.status === 'Paid';
      const themeColor = isPaid ? greenColor : primaryColor;
      const docTitle = isPaid ? 'RESIT RASMI' : 'INVOIS';
      const displayId = orderData.shortId || (orderData.orderId ? orderData.orderId.substring(0,8) : '---');
      const dateStr = orderData.timestamp ? new Date(orderData.timestamp.seconds*1000).toLocaleDateString('en-GB') : new Date().toLocaleDateString('en-GB');

      // HEADER
      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.setTextColor(...themeColor);
      doc.text(docTitle, 105, 20, {align: 'center'}); // Centered Title
      
      doc.setFontSize(12);
      doc.setTextColor(0,0,0);
      doc.text("KEDAI BUKU SEKOLAH", 105, 30, {align: 'center'});
      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text("SK Masjid Tanah (Integrasi)", 105, 35, {align: 'center'});
      doc.text("78300 Masjid Tanah, Melaka", 105, 40, {align: 'center'});
      
      // LINE
      doc.setLineWidth(0.5);
      doc.setDrawColor(200, 200, 200);
      doc.line(15, 45, 195, 45);

      // INFO SECTION
      doc.setFontSize(10);
      
      // Left Side (Bill To)
      doc.setFont("helvetica", "bold");
      doc.text("Kepada:", 15, 55);
      doc.setFont("helvetica", "normal");
      doc.text(orderData.parentName, 15, 60);
      doc.text(`Pelajar: ${orderData.studentName}`, 15, 65);
      doc.text(`Kelas: ${orderData.studentClass}`, 15, 70);
      if(orderData.nametag) doc.text(`Nametag: ${orderData.nametag}`, 15, 75);

      // Right Side (Details)
      doc.setFont("helvetica", "bold");
      doc.text("Butiran:", 140, 55);
      doc.setFont("helvetica", "normal");
      doc.text(`No. Rujukan:`, 140, 60);
      doc.text(`#${displayId}`, 195, 60, {align: 'right'});
      
      doc.text(`Tarikh:`, 140, 65);
      doc.text(dateStr, 195, 65, {align: 'right'});
      
      doc.text(`Status:`, 140, 70);
      doc.setFont("helvetica", "bold");
      if(isPaid) {
          doc.setTextColor(...greenColor);
          doc.text("PAID", 195, 70, {align: 'right'});
      } else {
          doc.setTextColor(...redColor);
          doc.text("BELUM BAYAR", 195, 70, {align: 'right'});
      }
      doc.setTextColor(0,0,0);

      // TABLE
      const tableData = [];
      if(orderData.items) {
          Object.values(orderData.items).forEach(i => {
              tableData.push([
                  i.name, 
                  i.quantity, 
                  `RM ${i.price.toFixed(2)}`, 
                  `RM ${(i.price * i.quantity).toFixed(2)}`
              ]);
          });
      }
      
      // Add Footer Row for Total
      tableData.push([
          {content: 'JUMLAH BESAR', colSpan: 3, styles: {halign: 'right', fontStyle: 'bold'}}, 
          {content: `RM ${orderData.total.toFixed(2)}`, styles: {fontStyle: 'bold', textColor: themeColor}}
      ]);

      doc.autoTable({
        startY: 85,
        head: [['Item / Perkara', 'Kuantiti', 'Harga Unit', 'Jumlah']],
        body: tableData,
        theme: 'striped',
        headStyles: { 
            fillColor: themeColor,
            textColor: [255, 255, 255],
            fontStyle: 'bold'
        },
        styles: {
            fontSize: 9,
            cellPadding: 3
        },
        columnStyles: {
            0: {cellWidth: 'auto'}, // Item
            1: {cellWidth: 20, halign: 'center'}, // Qty
            2: {cellWidth: 30, halign: 'right'}, // Price
            3: {cellWidth: 30, halign: 'right'} // Total
        }
      });
      
      // FOOTER NOTE
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text("* Resit ini dijana secara komputer dan sah tanpa tandatangan.", 105, finalY, {align: 'center'});
      if(!isPaid) {
           doc.text("* Sila jelaskan bayaran kepada guru kelas atau melalui perbankan internet.", 105, finalY + 5, {align: 'center'});
      } else {
           doc.text("* Terima kasih atas bayaran anda.", 105, finalY + 5, {align: 'center'});
      }

      if (returnBlob) return doc.output('blob');
      doc.save(`${docTitle}_${displayId}.pdf`);
    }

    // --- ORDER PROCESS LOGIC ---
    async function loadClasses() {
        if(!db) return;
        const doc = await db.collection('settings').doc('book_classes').get();
        allClasses = doc.exists && doc.data().list ? doc.data().list : [];
        const s = document.getElementById('studentClass');
        s.innerHTML = '<option value="">-- Pilih Kelas --</option>';
        allClasses.forEach(c => s.add(new Option(c,c)));
        updateClassesListAdmin();
    }

    function proceedToStep2() {
        const name = document.getElementById('parentName').value;
        const phone = document.getElementById('parentPhone').value;
        const student = document.getElementById('studentName').value;
        const cls = document.getElementById('studentClass').value;
        if(!name || !phone || !student || !cls) { showToast('Sila lengkapkan maklumat', 'error'); return; }
        currentOrderData = { parentName: name, parentPhone: phone, studentName: student, studentClass: cls, parentEmail: document.getElementById('parentEmail').value };
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        renderPackagesStep2();
        updateStepper(2);
        window.scrollTo(0,0);
    }
    
    function renderPackagesStep2() {
        const grid = document.getElementById('packagesGrid');
        grid.innerHTML = '';
        allPackages.forEach(p => {
            const isActive = selectedPackageId === p.id;
            let itemsListHtml = '<ul class="text-xs text-gray-500 list-disc ml-5 mt-2 space-y-1">';
            if(p.items && p.items.length > 0) {
                p.items.forEach(pi => {
                    const itemData = allItems.find(i => i.id === pi.itemId);
                    if(itemData) itemsListHtml += `<li>${itemData.name} <span class="text-gray-400 text-[10px]">(x${pi.qty})</span></li>`;
                });
            } else { itemsListHtml += '<li>Tiada barang tersenarai</li>'; }
            itemsListHtml += '</ul>';
            grid.innerHTML += `
            <div onclick="selectPackage('${p.id}')" class="flex flex-col h-full border-2 rounded-xl p-5 cursor-pointer transition-all relative overflow-hidden ${isActive ? 'border-blue-600 bg-blue-50 ring-2 ring-blue-100' : 'border-gray-200 hover:border-blue-300 hover:shadow-md'}">
                <div class="flex justify-between items-start mb-2">
                    <span class="font-bold text-lg text-gray-800">${p.name}</span>
                    ${isActive ? '<i class="fas fa-check-circle text-blue-600 text-xl"></i>' : '<div class="w-5 h-5 rounded-full border-2 border-gray-300"></div>'}
                </div>
                <div class="flex-1">
                    <div class="text-xs font-semibold text-gray-400 mb-1 uppercase tracking-wider">Kandungan Pakej:</div>
                    ${itemsListHtml}
                </div>
            </div>`;
        });
    }

    function selectPackage(id) {
        selectedPackageId = id;
        cart = {}; 
        if(id) {
            const pkg = allPackages.find(p => p.id === id);
            if(pkg && pkg.items) {
                pkg.items.forEach(pi => {
                    const item = allItems.find(i => i.id === pi.itemId);
                    if(item) cart[item.id] = { ...item, quantity: pi.qty, locked: true, type:'item' };
                });
            }
        }
        renderPackagesStep2();
    }

    function proceedToStep3() { 
        if (!selectedPackageId) { showToast('Sila pilih SATU pakej untuk meneruskan', 'error'); return; }
        document.getElementById('step2').classList.add('hidden'); 
        document.getElementById('step3').classList.remove('hidden'); 
        renderItemsStep3(); 
        updateStepper(3);
        window.scrollTo(0,0);
    }
    
    function renderItemsStep3() {
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = '';
        let total = 0;
        allItems.forEach(item => {
            const inCart = cart[item.id];
            const qty = inCart ? inCart.quantity : 0;
            const isLocked = inCart && inCart.locked;
            if(qty > 0) total += (item.price * qty);
            const input = isLocked 
                ? `<span class="font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded text-xs">PAKEJ (${qty})</span>`
                : `<input type="number" min="0" value="${qty}" class="w-16 border rounded text-center p-1" onchange="updateCart('${item.id}', this.value)">`;
            tbody.innerHTML += `
            <tr class="${qty > 0 ? 'bg-blue-50' : ''}">
                <td class="px-4 py-3 font-medium">${item.name}</td>
                <td class="px-4 py-3 text-right">RM ${item.price.toFixed(2)}</td>
                <td class="px-4 py-3 text-center">${input}</td>
            </tr>`;
        });
        document.getElementById('step3Total').textContent = `RM ${total.toFixed(2)}`;
    }

    function updateCart(id, qty) {
        qty = parseInt(qty);
        const item = allItems.find(i => i.id === id);
        if(qty > 0) cart[id] = { ...item, quantity: qty, type: 'item', locked: false };
        else if(cart[id] && !cart[id].locked) delete cart[id];
        renderItemsStep3();
    }

    function backToStep1() { 
        document.getElementById('step2').classList.add('hidden'); 
        document.getElementById('step1').classList.remove('hidden'); 
        updateStepper(1);
        window.scrollTo(0,0);
    }
    function backToStep2() { 
        document.getElementById('step3').classList.add('hidden'); 
        document.getElementById('step2').classList.remove('hidden'); 
        updateStepper(2);
        window.scrollTo(0,0);
    }
    function proceedToStep4() { 
        document.getElementById('step3').classList.add('hidden'); 
        document.getElementById('step4').classList.remove('hidden'); 
        updateStepper(4);
        window.scrollTo(0,0);
    }
    
    document.getElementById('nametagInput').addEventListener('input', function(e) { document.getElementById('charCount').textContent = `${this.value.length}/12`; });

    function backToStep3() { 
        document.getElementById('step4').classList.add('hidden'); 
        document.getElementById('step3').classList.remove('hidden'); 
        updateStepper(3);
        window.scrollTo(0,0);
    }
    function proceedToStep5() {
        currentOrderData.nametag = document.getElementById('nametagInput').value.trim().toUpperCase();
        document.getElementById('step4').classList.add('hidden');
        document.getElementById('step5').classList.remove('hidden');
        renderFeesStep5();
        renderFinalSummary();
        updateStepper(5);
        window.scrollTo(0,0);
    }
    
    function renderFeesStep5() {
        const tbody = document.getElementById('feesTableBody');
        tbody.innerHTML = '';
        allFees.forEach(f => {
            const selected = !!cart[f.id];
            tbody.innerHTML += `<tr><td class="py-3 px-2 font-medium">${f.name} <div class="text-xs text-gray-400 font-normal">${f.description||''}</div></td><td class="py-3 px-2 text-right">RM ${f.amount.toFixed(2)}</td><td class="py-3 px-2 text-center"><button onclick="toggleFee('${f.id}')" class="px-3 py-1 rounded text-xs font-bold ${selected ? 'bg-red-100 text-red-600':'bg-green-100 text-green-600'}">${selected ? 'Buang' : 'Tambah'}</button></td></tr>`;
        });
    }

    function toggleFee(id) {
        const fee = allFees.find(f => f.id === id);
        if(cart[id]) delete cart[id];
        else cart[id] = { ...fee, price: fee.amount, quantity: 1, type:'fee' };
        renderFeesStep5(); renderFinalSummary();
    }

    function renderFinalSummary() {
        const div = document.getElementById('cartItemsFinal');
        div.innerHTML = '';
        let total = 0;
        if(currentOrderData.nametag) {
            document.getElementById('nametagReview').classList.remove('hidden');
            document.getElementById('nametagDisplay').textContent = currentOrderData.nametag;
        } else { document.getElementById('nametagReview').classList.add('hidden'); }

        Object.values(cart).forEach(item => {
            const rowTotal = item.price * item.quantity;
            total += rowTotal;
            div.innerHTML += `<div class="flex justify-between"><span>${item.name} <span class="text-xs text-gray-400">x${item.quantity}</span></span><span class="font-bold">RM ${rowTotal.toFixed(2)}</span></div>`;
        });
        document.querySelector('.grandTotalDisplay').textContent = total.toFixed(2);
        
        const sel = document.getElementById('paymentMethod');
        sel.innerHTML = '';
        let hasOption = false;
        if (paymentConfig.cash) { sel.add(new Option('Tunai (Bayar di Sekolah)', 'Cash')); hasOption = true; }
        if (paymentConfig.online) { sel.add(new Option('Online Transfer', 'Online')); hasOption = true; }
        if (!hasOption) {
            sel.add(new Option('Tiada kaedah bayaran aktif', ''));
            document.getElementById('submitOrderBtn').disabled = true;
            document.getElementById('submitOrderBtn').innerText = "Bayaran Ditutup";
            document.getElementById('submitOrderBtn').classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            document.getElementById('submitOrderBtn').disabled = false;
            document.getElementById('submitOrderBtn').innerHTML = '<i class="fas fa-check-circle"></i> Sahkan Tempahan';
            document.getElementById('submitOrderBtn').classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
    
    function backToStep4() { 
        document.getElementById('step5').classList.add('hidden'); 
        document.getElementById('step4').classList.remove('hidden'); 
        updateStepper(4);
        window.scrollTo(0,0);
    }
    
    async function submitOrder() {
        const btn = document.getElementById('submitOrderBtn');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
        try {
            let total = 0; Object.values(cart).forEach(i => total += (i.price * i.quantity));
            const order = {
                ...currentOrderData, items: cart, total: total, status: 'New', 
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                shortId: Math.random().toString(36).substr(2, 6).toUpperCase(),
                paymentMethod: document.getElementById('paymentMethod').value
            };
            await db.collection('book_orders').add(order);
            lastOrderData = order;

            // --- PANGGIL FUNGSI TELEGRAM ---
            if(telegramConfig.botToken && telegramConfig.chatId) {
                sendTelegramNotification(order);
            }

            document.getElementById('successOrderId').textContent = order.shortId;
            document.getElementById('successModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-check-circle"></i> Sahkan Tempahan';
        } catch(e) { console.error(e); showToast('Ralat: ' + e.message, 'error'); btn.disabled = false; btn.innerHTML = "Sahkan Tempahan"; }
    }

    // --- FUNGSI BARU: NOTIFIKASI TELEGRAM ---
    async function sendTelegramNotification(order) {
        const itemsList = Object.values(order.items).map(i => `- ${i.name} (x${i.quantity})`).join('\n');
        const message = `
 *TEMPAHAN BARU #${order.shortId}*
--------------------------------
 *Pelajar:* ${order.studentName}
 *Kelas:* ${order.studentClass}
 *Ibu Bapa:* ${order.parentName}
 *Tel:* ${order.parentPhone}
 *Nametag:* ${order.nametag || 'TIADA'}
 *Bayaran:* ${order.paymentMethod}

 *Senarai Barang:*
${itemsList}

 *JUMLAH: RM ${order.total.toFixed(2)}*
`;
        const url = `https://api.telegram.org/bot${telegramConfig.botToken}/sendMessage`;
        try {
            await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: telegramConfig.chatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            });
            console.log("Telegram notification sent.");
        } catch (error) {
            console.error("Telegram error:", error);
        }
    }

    function finishOrder() {
        cart = {}; selectedPackageId = null; currentOrderData = {};
        ['parentName', 'parentPhone', 'parentEmail', 'studentName', 'studentClass', 'nametagInput'].forEach(id => {
            const el = document.getElementById(id); if(el) el.value = '';
        });
        document.getElementById('charCount').textContent = '0/12';
        document.getElementById('successModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
        returnToLandingPage();
    }

    // --- ADMIN PANEL LOGIC ---
    function checkAdminStatus() {
        if(auth.currentUser) {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('flex');
            showAdminTab('analysisTab');
            loadAdminData();
        } else { document.getElementById('adminLoginModal').classList.remove('hidden'); }
    }
    function toggleAdminPassword() {
        const input = document.getElementById('adminPassword');
        const icon = document.getElementById('togglePasswordIcon');
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    function verifyAdminLogin() {
        const e = document.getElementById('adminEmail').value;
        const p = document.getElementById('adminPassword').value;
        const btn = document.getElementById('adminLoginBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sedang Masuk...';
        btn.classList.add('opacity-70', 'cursor-not-allowed');
        auth.signInWithEmailAndPassword(e,p).then(() => {
            document.getElementById('adminLoginModal').classList.add('hidden');
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
            document.getElementById('adminPassword').value = '';
            checkAdminStatus();
        }).catch(err => {
            showToast('Log masuk gagal. Sila semak emel/kata laluan.', 'error');
            btn.disabled = false;
            btn.innerHTML = originalText;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
        });
    }
    function closeAdminLogin() { document.getElementById('adminLoginModal').classList.add('hidden'); }
    function logoutAdmin() {
        auth.signOut().then(() => {
             // Use the helper function to reset all views to Landing Page
             returnToLandingPage(); 
        });
    }
    function showAdminTab(id) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        const activeBtn = document.querySelector(`button[onclick="showAdminTab('${id}')"]`);
        if(activeBtn) activeBtn.classList.add('active');
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'analysisTab') renderAnalysis();
        if(id === 'ordersTab') loadOrders();
        if(id === 'itemsTab') loadItemsAdmin();
        if(id === 'feesTab') loadFeesAdmin();
        if(id === 'packagesTab') loadPackagesAdmin();
        if(id === 'classesTab') updateClassesListAdmin();
        if(id === 'settingsTab') loadSettings();
    }
    async function loadAdminData() {
        await Promise.all([loadClasses(), loadItems(), loadPackages(), loadFees()]);
        renderAnalysis();
    }

    // --- ADMIN: ANALYSIS ---
    async function renderAnalysis() {
        if(!db) return;
        const snap = await db.collection('book_orders').orderBy('timestamp', 'desc').limit(100).get();
        adminOrdersData = []; snap.forEach(d => adminOrdersData.push({id: d.id, ...d.data()}));
        let totalRevenue = 0, paidCount = 0, unpaidCount = 0, classSales = {};
        adminOrdersData.forEach(o => {
            totalRevenue += (o.total || 0);
            if(o.status === 'Paid') paidCount++; else unpaidCount++;
            const c = o.studentClass || 'Lain-lain';
            classSales[c] = (classSales[c] || 0) + (o.total || 0);
        });
        document.getElementById('statRevenue').innerText = totalRevenue.toFixed(2);
        document.getElementById('statOrders').innerText = adminOrdersData.length;
        document.getElementById('statPaid').innerText = paidCount;
        document.getElementById('statUnpaid').innerText = unpaidCount;
        const chartContainer = document.getElementById('classSalesChart');
        chartContainer.innerHTML = '';
        const maxSale = Math.max(...Object.values(classSales), 1);
        Object.entries(classSales).sort((a,b)=>b[1]-a[1]).slice(0, 5).forEach(([cls, amt]) => {
             const percent = (amt / maxSale) * 100;
             chartContainer.innerHTML += `<div class="mb-3"><div class="flex justify-between text-sm mb-1"><span class="font-bold text-gray-700">${cls}</span><span class="text-gray-500">RM ${amt.toFixed(2)}</span></div><div class="bar-container"><div class="bar-fill bg-blue-500" style="width: ${percent}%"></div></div></div>`;
        });
        const activityContainer = document.getElementById('recentActivityLog');
        activityContainer.innerHTML = '';
        adminOrdersData.slice(0, 5).forEach(o => {
            const time = o.timestamp ? new Date(o.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            activityContainer.innerHTML += `<div class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded"><div class="w-2 h-2 rounded-full ${o.status === 'Paid' ? 'bg-green-500' : 'bg-yellow-500'}"></div><div class="flex-1"><p class="font-bold text-gray-800">${o.studentName} <span class="text-xs font-normal text-gray-400">(${o.studentClass})</span></p><p class="text-xs text-gray-500">Tempahan #${o.shortId || '...'} - RM ${o.total.toFixed(2)}</p></div><div class="text-xs text-gray-400 font-mono">${time}</div></div>`;
        });
    }

    // --- ADMIN: ITEMS ---
    function showAddItemForm() { document.getElementById('addItemForm').classList.remove('hidden'); }
    function hideAddItemForm() { document.getElementById('addItemForm').classList.add('hidden'); }
    async function loadItems() { 
        const s = await db.collection('book_items').get();
        allItems = []; s.forEach(d => allItems.push({id: d.id, ...d.data()}));
        allItems.sort((a,b) => a.name.localeCompare(b.name));
    }
    function loadItemsAdmin() {
        const tbody = document.getElementById('itemsAdminTableBody');
        tbody.innerHTML = '';
        if(allItems.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="p-6 text-center text-gray-400">Tiada barang.</td></tr>'; return; }
        allItems.forEach(i => {
            tbody.innerHTML += `<tr class="hover:bg-gray-50 group border-b border-gray-100 last:border-0"><td class="p-4 font-medium text-gray-700">${i.name}</td><td class="p-4 text-right font-mono">RM ${i.price.toFixed(2)}</td><td class="p-4 text-center"><button onclick="deleteItem('${i.id}')" class="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-all"><i class="fas fa-trash-alt"></i></button></td></tr>`;
        });
    }
    async function addItem() {
        const n = document.getElementById('newItemName').value, p = parseFloat(document.getElementById('newItemPrice').value);
        if(n && p) {
            await db.collection('book_items').add({name: n, price: p});
            document.getElementById('newItemName').value = ''; document.getElementById('newItemPrice').value = '';
            hideAddItemForm(); await loadItems(); loadItemsAdmin(); showToast('Barang ditambah', 'success');
        }
    }
    async function deleteItem(id) {
        showConfirm('Padam barang ini?', async() => {
            await db.collection('book_items').doc(id).delete();
            await loadItems(); loadItemsAdmin();
        });
    }

    // --- ADMIN: ORDERS ---
    async function loadOrders() {
        const s = await db.collection('book_orders').orderBy('timestamp', 'desc').limit(50).get();
        adminOrdersData = []; s.forEach(d => adminOrdersData.push({id: d.id, ...d.data()}));
        renderOrders();
    }
    function renderOrders() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        const filter = document.getElementById('adminSearchInput').value.toLowerCase();
        adminOrdersData.filter(o => 
            !filter || (o.studentName && o.studentName.toLowerCase().includes(filter)) || (o.shortId && o.shortId.toLowerCase().includes(filter))
        ).forEach(o => {
            const date = o.timestamp ? new Date(o.timestamp.seconds*1000).toLocaleDateString() : '-';
            const status = o.status || 'New';
            let actionButtons = '';
            if (status === 'Processing') {
                actionButtons = `<button onclick="downloadDoc('${o.id}', false)" class="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold mr-1" title="Invois"><i class="fas fa-file-invoice"></i> Invois</button>`;
            } else if (status === 'Paid') {
                actionButtons = `<button onclick="downloadDoc('${o.id}', true)" class="text-green-600 hover:bg-green-50 px-2 py-1 rounded text-xs font-bold mr-1" title="Resit"><i class="fas fa-receipt"></i> Resit</button>`;
            }
            const statusSelect = `
            <select onchange="updateStatus('${o.id}', this.value)" class="text-xs border rounded p-1 bg-white focus:ring-2 focus:ring-blue-300 font-medium ${status==='Paid'?'text-green-700 border-green-200':(status==='Processing'?'text-blue-700 border-blue-200':'text-yellow-700 border-yellow-200')}">
                <option value="New" ${status==='New'?'selected':''}>Baru</option>
                <option value="Processing" ${status==='Processing'?'selected':''}>Proses</option>
                <option value="Paid" ${status==='Paid'?'selected':''}>PAID</option>
            </select>`;
            tbody.innerHTML += `
            <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0 cursor-pointer" onclick="viewOrderDetails('${o.id}')">
                <td class="p-4 text-center"><input type="checkbox" value="${o.id}" class="order-checkbox rounded border-gray-300" onclick="event.stopPropagation()"></td>
                <td class="p-4 text-xs text-gray-500"><span class="font-mono font-bold text-gray-800">#${o.shortId}</span><br>${date}</td>
                <td class="p-4 font-medium text-gray-800">${o.studentName}</td>
                <td class="p-4 text-gray-600">${o.studentClass}</td>
                <td class="p-4 font-mono font-bold">RM ${o.total.toFixed(2)}</td>
                <td class="p-4" onclick="event.stopPropagation()">${statusSelect}</td>
                <td class="p-4 text-center flex items-center justify-center" onclick="event.stopPropagation()">
                    ${actionButtons}
                    <button onclick="deleteOrder('${o.id}')" class="text-red-400 hover:text-red-600 p-2 rounded ml-1" title="Padam"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }
    function downloadDoc(id, isReceipt) {
        const order = adminOrdersData.find(o => o.id === id);
        if(order) generateInvoicePDF(order, false);
    }
    function viewOrderDetails(id) {
        const o = adminOrdersData.find(x => x.id === id);
        if(!o) return;
        let itemsHtml = '';
        Object.values(o.items).forEach(i => {
             itemsHtml += `<div class="flex justify-between py-2 border-b border-dashed border-gray-200 last:border-0"><span>${i.name} <span class="text-gray-400 text-xs">x${i.quantity}</span></span><span class="font-mono">RM ${(i.price*i.quantity).toFixed(2)}</span></div>`;
        });
        document.getElementById('orderDetailsContent').innerHTML = `<div class="grid grid-cols-2 gap-4 mb-4 bg-gray-50 p-4 rounded-xl border border-gray-100"><div><p class="text-xs text-gray-400 uppercase">Pelajar</p><p class="font-bold">${o.studentName}</p></div><div><p class="text-xs text-gray-400 uppercase">Kelas</p><p class="font-bold">${o.studentClass}</p></div><div><p class="text-xs text-gray-400 uppercase">Ibu Bapa</p><p class="font-bold">${o.parentName}</p></div><div><p class="text-xs text-gray-400 uppercase">Telefon</p><p class="font-bold">${o.parentPhone}</p></div></div>${o.nametag ? `<div class="bg-yellow-50 text-yellow-800 p-3 rounded-lg mb-4 text-center border border-yellow-200 font-bold">NAMETAG: ${o.nametag}</div>` : ''}<div class="bg-white border border-gray-200 rounded-xl p-4 mb-4"><h4 class="font-bold text-gray-700 mb-2 border-b pb-2">Item</h4>${itemsHtml}<div class="flex justify-between mt-3 pt-2 border-t font-bold text-lg"><span>Jumlah</span><span class="text-blue-600">RM ${o.total.toFixed(2)}</span></div></div><div class="text-xs text-gray-400 text-center">ID Rujukan: ${o.id}</div>`;
        document.getElementById('orderDetailsModal').classList.remove('hidden');
    }
    async function updateStatus(id, s) { 
        await db.collection('book_orders').doc(id).update({status: s}); 
        const idx = adminOrdersData.findIndex(o => o.id === id);
        if(idx !== -1) adminOrdersData[idx].status = s;
        renderOrders(); renderAnalysis();
        showToast('Status dikemaskini', 'success');
    }
    async function deleteOrder(id) { 
        showConfirm('Padam tempahan ini?', async () => {
            await db.collection('book_orders').doc(id).delete();
            adminOrdersData = adminOrdersData.filter(o => o.id !== id);
            renderOrders(); renderAnalysis();
            showToast('Tempahan dipadam', 'success');
        });
    }

    // --- ADMIN: PACKAGES ---
    async function loadPackages() {
        const s = await db.collection('book_packages').get();
        allPackages = []; s.forEach(d => allPackages.push({id:d.id, ...d.data()}));
    }
    function loadPackagesAdmin() {
        const div = document.getElementById('packagesListContainer');
        div.innerHTML = '';
        allPackages.forEach(p => {
            let itemsList = '<ul class="text-xs text-gray-500 mt-2 list-disc ml-4 space-y-1">';
            if(p.items && p.items.length) {
                p.items.forEach(pi => {
                    const iData = allItems.find(x => x.id === pi.itemId);
                    if(iData) itemsList += `<li>${iData.name} (x${pi.qty})</li>`;
                });
            } else { itemsList += '<li>Tiada item.</li>'; }
            itemsList += '</ul>';
            div.innerHTML += `
            <div class="p-4 border border-gray-200 rounded-xl bg-white shadow-sm flex flex-col justify-between">
                <div>
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-lg text-gray-800">${p.name}</span>
                        <button onclick="deletePackage('${p.id}')" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-trash"></i></button>
                    </div>
                    ${itemsList}
                </div>
                <div class="mt-3 pt-2 border-t border-gray-100 text-xs text-gray-400 text-right">ID: ${p.id.substring(0,6)}</div>
            </div>`;
        });
    }
    function showAddPackageForm() { 
        document.getElementById('addPackageForm').classList.remove('hidden');
        const list = document.getElementById('packageItemsList');
        list.innerHTML = '';
        allItems.forEach(i => {
            list.innerHTML += `<div class="flex items-center gap-2 mb-1 border-b pb-1 last:border-0"><input type="checkbox" class="pkg-item-cb" value="${i.id}"> <span class="text-sm flex-1">${i.name}</span> <input type="number" class="pkg-item-qty w-12 text-xs border p-1 rounded" value="1"></div>`;
        });
    }
    function hideAddPackageForm() { document.getElementById('addPackageForm').classList.add('hidden'); }
    async function addPackage() {
        const n = document.getElementById('newPackageName').value;
        const items = [];
        document.querySelectorAll('.pkg-item-cb:checked').forEach(cb => {
            const qty = cb.parentElement.querySelector('.pkg-item-qty').value;
            items.push({itemId: cb.value, qty: parseInt(qty)});
        });
        if(n && items.length) {
            await db.collection('book_packages').add({name: n, items: items});
            hideAddPackageForm(); loadPackages().then(loadPackagesAdmin);
        }
    }
    async function deletePackage(id) { await db.collection('book_packages').doc(id).delete(); loadPackages().then(loadPackagesAdmin); }

    // --- ADMIN: FEES & CLASSES ---
    async function loadFees() { const s = await db.collection('pibg_fees').get(); allFees = []; s.forEach(d => allFees.push({id:d.id, ...d.data()})); }
    function loadFeesAdmin() {
        const b = document.getElementById('feesAdminTableBody'); b.innerHTML = '';
        allFees.forEach(f => { b.innerHTML += `<tr><td class="p-3">${f.name}</td><td class="p-3 text-right">RM ${f.amount}</td><td class="p-3 text-center"><button onclick="deleteFee('${f.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`; });
    }
    function showAddFeeForm() { document.getElementById('addFeeForm').classList.remove('hidden'); }
    function hideAddFeeForm() { document.getElementById('addFeeForm').classList.add('hidden'); }
    async function addFee() {
        const n = document.getElementById('newFeeName').value, a = parseFloat(document.getElementById('newFeeAmount').value), d = document.getElementById('newFeeDescription').value;
        if(n && a) { await db.collection('pibg_fees').add({name:n, amount:a, description:d}); hideAddFeeForm(); loadFees().then(loadFeesAdmin); }
    }
    async function deleteFee(id) { await db.collection('pibg_fees').doc(id).delete(); loadFees().then(loadFeesAdmin); }

    function updateClassesListAdmin() {
        const d = document.getElementById('classesListAdmin'); d.innerHTML = '';
        allClasses.forEach(c => { d.innerHTML += `<div class="bg-gray-50 border p-3 rounded-lg flex justify-between items-center"><span class="font-bold text-gray-700">${c}</span><button onclick="deleteClass('${c}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`; });
    }
    async function addClass() {
        const v = document.getElementById('newClassName').value.toUpperCase();
        if(v && !allClasses.includes(v)) {
            allClasses.push(v); allClasses.sort(); await db.collection('settings').doc('book_classes').set({list: allClasses});
            document.getElementById('newClassName').value = ''; updateClassesListAdmin();
        }
    }
    async function deleteClass(v) {
        showConfirm('Padam kelas ini?', async() => {
            allClasses = allClasses.filter(c => c !== v); await db.collection('settings').doc('book_classes').set({list: allClasses}); updateClassesListAdmin();
        });
    }

    async function loadSettings() {
        if(!db) return;
        const p = await db.collection('settings').doc('payment_config').get();
        if(p.exists) { 
            paymentConfig = p.data(); 
            const c = document.getElementById('toggleCash');
            const o = document.getElementById('toggleOnline');
            if(c) c.checked = paymentConfig.cash;
            if(o) o.checked = paymentConfig.online;
        }
        const t = await db.collection('settings').doc('telegram_settings').get();
        if(t.exists) { 
            // Load and store globally
            telegramConfig = {
                botToken: t.data().botToken || '',
                chatId: t.data().chatId || ''
            };
            document.getElementById('telegramBotToken').value = telegramConfig.botToken; 
            document.getElementById('telegramChatId').value = telegramConfig.chatId; 
        }
    }
    async function savePaymentSettings() {
        const c = document.getElementById('toggleCash').checked;
        const o = document.getElementById('toggleOnline').checked;
        await db.collection('settings').doc('payment_config').set({cash:c, online:o});
        paymentConfig = { cash: c, online: o };
        showToast('Tetapan bayaran disimpan', 'success');
    }
    async function saveTelegramSettings() {
        const t = document.getElementById('telegramBotToken').value, c = document.getElementById('telegramChatId').value;
        await db.collection('settings').doc('telegram_settings').set({botToken:t, chatId:c});
        telegramConfig = { botToken: t, chatId: c }; // Update global var immediately
        showToast('Tetapan Telegram disimpan', 'success');
    }
    function toggleSelectAll(src, cls) { document.querySelectorAll('.'+cls).forEach(c => c.checked = src.checked); }
    async function deleteSelectedOrders() {
        const ids = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(c => c.value);
        if(ids.length === 0) return;
        showConfirm(`Padam ${ids.length} tempahan?`, async() => {
            const batch = db.batch(); ids.forEach(id => batch.delete(db.collection('book_orders').doc(id)));
            await batch.commit(); loadOrders(); renderAnalysis(); showToast('Tempahan dipadam', 'success');
        });
    }
    async function checkStatus() {
        const p = document.getElementById('statusPhone').value, r = document.getElementById('statusResults');
        r.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin"></i> Sedang mencari...</div>';
        publicStatusData = [];
        const s = await db.collection('book_orders').where('parentPhone','==',p).get();
        r.innerHTML = '';
        if(s.empty) { 
            r.innerHTML = '<div class="text-red-500 bg-red-50 p-4 rounded-xl border border-red-100 text-center shadow-sm">Tiada rekod dijumpai untuk nombor telefon ini.</div>'; 
            return; 
        }
        let results = [];
        s.forEach(doc => { results.push({id: doc.id, ...doc.data()}); });
        results.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.seconds : 0;
            const timeB = b.timestamp ? b.timestamp.seconds : 0;
            return timeB - timeA;
        });
        results.forEach(o => {
            publicStatusData.push(o); 
            let actionBtn = '';
            if(o.status === 'Paid') {
                 actionBtn = `<button onclick="downloadPublicDoc('${o.id}')" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold hover:bg-green-200 transition-colors flex items-center gap-2 shadow-sm"><i class="fas fa-file-invoice-dollar"></i> Resit</button>`;
            } else {
                 actionBtn = `<button onclick="downloadPublicDoc('${o.id}')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition-colors flex items-center gap-2 shadow-sm"><i class="fas fa-file-invoice"></i> Invois</button>`;
            }
            r.innerHTML += `
            <div class="border rounded-xl p-5 bg-white shadow-sm mb-3 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-bold text-lg text-gray-800">${o.studentName}</div>
                        <div class="text-xs text-gray-500 font-mono">#${o.shortId}  ${o.timestamp ? new Date(o.timestamp.seconds*1000).toLocaleDateString() : ''}</div>
                    </div>
                    <span class="${o.status==='Paid'?'bg-green-100 text-green-700 border-green-200':'bg-yellow-100 text-yellow-700 border-yellow-200'} text-xs px-2 py-1 rounded border font-bold uppercase tracking-wider">
                        ${o.status==='Paid'?'PAID':(o.status==='Processing'?'PROSES':'BARU')}
                    </span>
                </div>
                <div class="text-sm text-gray-600 mb-3 flex items-center gap-2"><i class="fas fa-graduation-cap text-gray-400"></i> Kelas: ${o.studentClass}</div>
                <div class="pt-3 border-t border-dashed border-gray-200 flex justify-between items-center">
                    <span class="font-bold text-blue-600 text-lg">RM ${o.total.toFixed(2)}</span>
                    ${actionBtn}
                </div>
            </div>`;
        });
    }
    function downloadPublicDoc(id) {
        const order = publicStatusData.find(o => o.id === id);
        if(order) generateInvoicePDF(order);
        else showToast('Ralat data, sila cari semula.', 'error');
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadClasses(); loadItems(); loadPackages(); loadFees();
        loadSettings();
    });
  </script>
 </body>
</html>
